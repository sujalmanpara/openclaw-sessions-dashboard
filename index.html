<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenClaw Sessions</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}

:root{
  --bg-base:#09090b;
  --bg-surface:#0c0c10;
  --bg-elevated:#141418;
  --border-subtle:#1e1e24;
  --border-default:#2a2a32;
  --border-hover:#3a3a44;
  --text-primary:#fafafa;
  --text-secondary:#a1a1aa;
  --text-muted:#71717a;
  --text-dim:#3f3f46;
  --accent:#7c6ff7;
  --green:#22c55e;
  --yellow:#eab308;
  --red:#ef4444;
  --blue:#3b82f6;
  --font-mono:'SF Mono',Monaco,'Cascadia Code',monospace;
  --font-sans:-apple-system,BlinkMacSystemFont,'Segoe UI','Inter',sans-serif;
  --radius:8px;
}

@media(prefers-reduced-motion:reduce){
  *,*::before,*::after{animation-duration:0.01ms!important;transition-duration:0.01ms!important}
}

body{
  font-family:var(--font-sans);
  background:var(--bg-base);
  color:var(--text-primary);
  height:100dvh;
  line-height:1.5;
  font-size:13px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

/* ── Header ── */
.header{
  padding:8px 16px;
  border-bottom:1px solid var(--border-subtle);
  display:flex;
  align-items:center;
  justify-content:space-between;
  position:sticky;top:0;
  background:var(--bg-base);
  z-index:50;
  flex-shrink:0;
}

.header h1{
  font-size:14px;
  font-weight:600;
  display:flex;align-items:center;gap:8px;
  text-wrap:balance;
  color:var(--text-primary);
}

.header h1 .brand{color:var(--text-secondary);font-weight:500}

.live-dot{
  width:6px;height:6px;
  background:var(--green);
  border-radius:50%;
  animation:pulse 2s infinite;
}

@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

.controls{display:flex;align-items:center;gap:8px}

.btn{
  background:var(--bg-elevated);
  border:1px solid var(--border-default);
  color:var(--text-muted);
  padding:4px 12px;
  border-radius:var(--radius);
  cursor:pointer;
  font-size:12px;
  transition:border-color .15s,color .15s,background .15s;
  display:flex;align-items:center;gap:4px;
  font-family:inherit;
}
.btn:hover{border-color:var(--border-hover);color:var(--text-secondary)}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.primary:hover{opacity:.85}

/* ── Stats Bar (compact) ── */
.cost-dashboard{
  padding:4px 16px;
  border-bottom:1px solid var(--border-subtle);
  background:var(--bg-surface);
  display:flex;align-items:center;gap:16px;
  flex-shrink:0;
  overflow-x:auto;
}

.cost-stat{
  display:flex;align-items:baseline;gap:4px;
  white-space:nowrap;
}
.cost-value{
  font-size:13px;font-weight:600;
  color:var(--text-primary);
  font-variant-numeric:tabular-nums;
}
.cost-label{
  font-size:11px;color:var(--text-dim);
}

.api-keys{
  display:flex;gap:4px;align-items:center;
  margin-left:auto;
}
.api-key{
  font-size:10px;padding:2px 6px;
  background:var(--bg-elevated);
  border:1px solid var(--border-subtle);
  border-radius:4px;
  color:var(--text-muted);
  display:flex;align-items:center;gap:4px;
}
.api-key.active{border-color:rgba(34,197,94,.4);color:var(--text-secondary)}
.key-status{width:6px;height:6px;border-radius:50%;background:var(--green)}

/* ── Toolbar ── */
.toolbar{
  padding:8px 16px;
  border-bottom:1px solid var(--border-subtle);
  display:flex;gap:8px;align-items:center;
  flex-shrink:0;
}

.search-box{flex:1;min-width:160px;position:relative}
.search-input{
  width:100%;padding:6px 8px 6px 28px;
  background:var(--bg-elevated);
  border:1px solid var(--border-default);
  border-radius:var(--radius);
  color:var(--text-primary);
  font-size:13px;font-family:inherit;
}
.search-input::placeholder{color:var(--text-dim)}
.search-input:focus{outline:none;border-color:var(--accent)}
.search-icon{
  position:absolute;left:8px;top:50%;transform:translateY(-50%);
  color:var(--text-dim);font-size:13px;pointer-events:none;
}

.view-controls{display:flex;gap:4px;align-items:center}
.view-toggle{
  background:var(--bg-elevated);border:1px solid var(--border-default);
  padding:4px 8px;border-radius:var(--radius);cursor:pointer;
  color:var(--text-muted);font-size:13px;
  transition:border-color .15s,color .15s;
}
.view-toggle:hover{border-color:var(--border-hover);color:var(--text-secondary)}
.view-toggle.active{background:var(--accent);color:#fff;border-color:var(--accent)}

.sort-select{
  appearance:none;background:var(--bg-elevated);
  border:1px solid var(--border-default);
  color:var(--text-secondary);padding:4px 24px 4px 8px;
  border-radius:var(--radius);cursor:pointer;font-size:12px;
  font-family:inherit;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%2371717a'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 8px center;
}

/* ── Filter Bar ── */
.filter-bar{
  padding:4px 16px;
  border-bottom:1px solid var(--border-subtle);
  display:flex;gap:4px;flex-wrap:wrap;
  background:var(--bg-base);
  flex-shrink:0;
  position:relative;
  z-index:10;
}
.filter-btn{
  background:transparent;border:1px solid var(--border-subtle);
  color:var(--text-dim);padding:2px 8px;
  border-radius:var(--radius);cursor:pointer;
  font-size:11px;font-family:inherit;
  transition:border-color .15s,color .15s;
}
.filter-btn:hover{border-color:var(--border-default);color:var(--text-muted)}
.filter-btn.active{
  background:rgba(124,111,247,.08);color:var(--text-secondary);
  border-color:rgba(124,111,247,.3);
}

/* ── Settings Panel ── */
.settings-panel{
  background:var(--bg-elevated);border:1px solid var(--border-default);
  border-radius:var(--radius);padding:12px 16px;margin:8px 16px;
}
.setting-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0}
.setting-label{font-size:12px;color:var(--text-secondary)}
.toggle-switch{
  position:relative;width:36px;height:20px;
  background:var(--bg-surface);border:1px solid var(--border-default);
  border-radius:10px;cursor:pointer;transition:background .15s;
}
.toggle-switch.on{background:var(--accent);border-color:var(--accent)}
.toggle-knob{
  position:absolute;width:16px;height:16px;
  background:#fff;border-radius:50%;top:1px;left:1px;
  transition:transform .15s;
}
.toggle-switch.on .toggle-knob{transform:translateX(16px)}

/* ── Main Layout ── */
.main-content{
  display:flex;flex:1;overflow:hidden;
}

.sessions-panel{flex:1;overflow-y:auto;padding:12px 16px}

.breadcrumb{
  display:flex;align-items:center;gap:4px;
  margin-bottom:8px;font-size:11px;
}
.breadcrumb-item{
  color:var(--text-muted);cursor:pointer;padding:2px 4px;
  border-radius:4px;transition:color .15s;
}
.breadcrumb-item:hover{color:var(--text-primary)}
.breadcrumb-separator{color:var(--text-dim);font-size:10px}

/* ── Sessions Grid ── */
.sessions-grid{display:grid;gap:8px}
.grid-view{grid-template-columns:repeat(auto-fill,minmax(340px,1fr))}
.list-view{grid-template-columns:1fr}

/* ── Session Card ── */
.session-card{
  background:var(--bg-surface);
  border:1px solid var(--border-subtle);
  border-radius:var(--radius);
  padding:12px;
  cursor:pointer;
  transition:border-color .15s;
  position:relative;
}
.session-card:hover{border-color:var(--border-default)}
.session-card.expanded{border-color:rgba(124,111,247,.3)}
.session-card.keyboard-focus{outline:2px solid var(--accent);outline-offset:2px}

.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.card-title{
  font-size:13px;font-weight:600;
  display:flex;align-items:center;gap:8px;
  flex:1;min-width:0;
}
.card-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

.status-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.status-dot.status-running{background:var(--green);animation:pulse 2s infinite}
.status-dot.status-idle{background:var(--yellow)}
.status-dot.status-completed{background:var(--text-dim)}
.status-dot.status-failed{background:var(--red)}

.pin-btn{
  background:none;border:none;color:var(--text-dim);
  cursor:pointer;padding:4px;border-radius:4px;font-size:13px;
  transition:color .15s;
}
.pin-btn:hover{color:var(--text-muted)}
.pin-btn.pinned{color:var(--yellow)}

.card-badges{display:flex;gap:4px;flex-wrap:wrap;align-items:center}

.badge{
  font-size:10px;padding:1px 6px;border-radius:4px;
  font-weight:500;border:1px solid;
}
.badge-main{background:rgba(34,197,94,.06);color:rgba(34,197,94,.6);border-color:rgba(34,197,94,.12)}
.badge-group{background:rgba(59,130,246,.06);color:rgba(59,130,246,.6);border-color:rgba(59,130,246,.12)}
.badge-cron{background:rgba(234,179,8,.06);color:rgba(234,179,8,.5);border-color:rgba(234,179,8,.1)}
.badge-run{background:rgba(234,179,8,.04);color:rgba(234,179,8,.5);border-color:rgba(234,179,8,.08)}
.badge-subagent{background:rgba(124,111,247,.06);color:rgba(124,111,247,.6);border-color:rgba(124,111,247,.1)}
.badge-telegram{background:rgba(59,130,246,.06);color:rgba(59,130,246,.6);border-color:rgba(59,130,246,.12)}
.badge-other{background:rgba(113,113,122,.06);color:var(--text-muted);border-color:rgba(113,113,122,.12)}

.model-pill{
  font-size:10px;padding:1px 6px;
  background:var(--bg-elevated);border:1px solid var(--border-subtle);
  border-radius:4px;color:var(--text-muted);margin-left:auto;
}

.card-meta{
  display:flex;flex-wrap:wrap;gap:8px;
  margin-bottom:8px;font-size:11px;color:var(--text-dim);
  font-variant-numeric:tabular-nums;
}

.token-summary{display:flex;align-items:center;gap:8px;margin:4px 0}
.token-bar{
  flex:1;height:4px;background:var(--bg-elevated);
  border-radius:2px;overflow:hidden;display:flex;
}
.token-fill-in{height:100%;background:rgba(59,130,246,.5)}
.token-fill-out{height:100%;background:rgba(124,111,247,.5)}
.token-text{font-size:10px;color:var(--text-dim);white-space:nowrap;font-variant-numeric:tabular-nums}
.cost-display{font-size:10px;color:var(--text-muted);font-weight:500;font-variant-numeric:tabular-nums}

.activity-section{margin-top:8px;border-top:1px solid var(--border-subtle);padding-top:8px}
.activity-item{font-size:11px;padding:2px 0;display:flex;gap:8px;align-items:baseline}
.activity-action{color:var(--text-muted);font-weight:500;white-space:nowrap;font-size:11px}
.activity-detail{
  color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;
  white-space:nowrap;font-family:var(--font-mono);font-size:10px;flex:1;
}
.activity-time{color:var(--text-dim);font-size:10px;white-space:nowrap;font-variant-numeric:tabular-nums}

.children-section{margin-top:8px;border-top:1px solid var(--border-subtle);padding-top:8px}
.children-toggle{display:flex;align-items:center;justify-content:space-between;cursor:pointer;margin-bottom:4px}
.children-label{font-size:11px;color:var(--text-muted);font-weight:500}
.expand-icon{transition:transform .15s;color:var(--text-dim);font-size:10px}
.children-section.expanded .expand-icon{transform:rotate(90deg)}
.children-list{display:none;gap:4px;flex-direction:column}
.children-section.expanded .children-list{display:flex}

.child-item{
  font-size:11px;padding:4px 8px;
  background:var(--bg-elevated);border:1px solid var(--border-subtle);
  border-radius:var(--radius);cursor:pointer;
  display:flex;justify-content:space-between;align-items:center;
  transition:border-color .15s;
}
.child-item:hover{border-color:var(--border-default)}

/* ── Detail Panel ── */
.detail-panel{
  position:fixed;top:0;right:0;
  width:480px;height:100dvh;
  background:var(--bg-surface);
  border-left:1px solid var(--border-subtle);
  display:flex;flex-direction:column;
  z-index:60;
  box-shadow:-8px 0 24px rgba(0,0,0,.4);
}

.panel-header{
  padding:12px 16px;
  border-bottom:1px solid var(--border-subtle);
  display:flex;justify-content:space-between;align-items:center;
  flex-shrink:0;
}
.panel-title{
  font-size:14px;font-weight:600;flex:1;min-width:0;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
  text-wrap:balance;
}
.panel-controls{display:flex;gap:4px;align-items:center}

.panel-meta{
  padding:8px 16px;font-size:11px;color:var(--text-dim);
  border-bottom:1px solid var(--border-subtle);
  display:flex;gap:8px;flex-wrap:wrap;align-items:center;
  background:var(--bg-elevated);flex-shrink:0;
}

.log-container{flex:1;overflow-y:auto;padding:0 16px;padding-bottom:8px}
.send-bar{display:flex;gap:8px;padding:12px 16px;border-top:1px solid var(--border);background:var(--bg-primary);flex-shrink:0}
.send-bar input{flex:1;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:8px 12px;color:var(--text-primary);font-size:13px;outline:none;transition:border-color .15s}
.send-bar input:focus{border-color:var(--accent)}
.send-bar input::placeholder{color:var(--text-muted)}
.send-btn{padding:8px 12px !important;background:var(--accent) !important;color:#fff !important;border-radius:6px !important;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.send-btn:hover{opacity:.85}
.send-btn:disabled{opacity:.4;cursor:not-allowed}

.log-entry{margin:12px 0;padding-left:12px;border-left:2px solid var(--border-subtle)}
.log-entry.role-user{border-color:rgba(59,130,246,.3)}
.log-entry.role-assistant{border-color:rgba(124,111,247,.3)}
.log-entry.role-tool{border-color:rgba(234,179,8,.2)}

.log-header{display:flex;align-items:center;margin-bottom:4px;gap:8px}
.log-role{
  font-size:10px;font-weight:600;text-transform:uppercase;
  padding:1px 6px;border-radius:4px;border:1px solid;
}
.role-user{background:rgba(59,130,246,.08);color:rgba(59,130,246,.6);border-color:rgba(59,130,246,.12)}
.role-assistant{background:rgba(124,111,247,.08);color:rgba(124,111,247,.6);border-color:rgba(124,111,247,.12)}
.role-tool{background:rgba(234,179,8,.06);color:rgba(234,179,8,.5);border-color:rgba(234,179,8,.1)}

.log-timestamp{font-size:10px;color:var(--text-dim);margin-left:auto;font-variant-numeric:tabular-nums}
.log-content{margin-bottom:4px}

.log-text{font-size:13px;line-height:1.6;white-space:pre-wrap;word-break:break-word;color:var(--text-secondary)}
.log-text h1,.log-text h2,.log-text h3{margin:8px 0 4px;color:var(--text-primary);text-wrap:balance}
.log-text h1{font-size:18px}.log-text h2{font-size:15px}.log-text h3{font-size:14px}
.log-text p{margin:4px 0}
.log-text ul,.log-text ol{margin:4px 0;padding-left:20px}
.log-text code{
  background:var(--bg-elevated);padding:1px 4px;border-radius:4px;
  font-family:var(--font-mono);font-size:12px;
}
.log-text pre{
  background:var(--bg-elevated);padding:8px 12px;border-radius:var(--radius);
  overflow-x:auto;margin:8px 0;border:1px solid var(--border-subtle);
}
.log-text pre code{background:none;padding:0}
.log-text a{color:var(--accent);text-decoration:none}
.log-text a:hover{text-decoration:underline}

.tool-call{
  background:var(--bg-elevated);border:1px solid var(--border-subtle);
  border-radius:var(--radius);margin:8px 0;overflow:hidden;
}
.tool-header{
  padding:8px 12px;background:var(--bg-surface);
  border-bottom:1px solid var(--border-subtle);
  display:flex;justify-content:space-between;align-items:center;cursor:pointer;
}
.tool-name{font-size:12px;color:var(--text-secondary);font-weight:500;display:flex;align-items:center;gap:4px}
.tool-toggle{color:var(--text-dim);transition:transform .15s;font-size:10px}
.tool-call.expanded .tool-toggle{transform:rotate(180deg)}
.tool-content{display:none}
.tool-call.expanded .tool-content{display:block}

.tool-args,.tool-result{padding:8px 12px;font-size:11px;font-family:var(--font-mono)}
.tool-args{
  color:var(--text-muted);background:var(--bg-base);
  white-space:pre-wrap;word-break:break-all;border-bottom:1px solid var(--border-subtle);
}
.tool-result{color:var(--text-secondary);background:var(--bg-surface)}
.tool-pending{padding:8px 12px;color:var(--text-dim);font-style:italic;font-size:11px;background:var(--bg-base)}

.copy-btn{
  background:var(--bg-elevated);border:1px solid var(--border-default);
  color:var(--text-dim);padding:2px 8px;border-radius:4px;
  cursor:pointer;font-size:10px;transition:color .15s;font-family:inherit;
}
.copy-btn:hover{color:var(--text-secondary)}

.image-preview{
  max-width:100%;max-height:300px;border-radius:var(--radius);
  border:1px solid var(--border-subtle);margin:8px 0;cursor:pointer;
  transition:border-color .15s;
}
.image-preview:hover{border-color:var(--border-default)}

.thinking-block{
  background:var(--bg-elevated);border:1px solid var(--border-subtle);
  border-radius:var(--radius);padding:8px 12px;margin:8px 0;
  font-style:italic;color:var(--text-muted);font-size:11px;
}

.log-meta{display:flex;gap:8px;margin-top:4px;font-size:10px;color:var(--text-dim);font-variant-numeric:tabular-nums}
.log-cost{color:var(--text-muted);font-weight:500;background:rgba(234,179,8,.06);padding:1px 4px;border-radius:4px}
.log-tokens{color:var(--text-dim)}
.log-model{color:var(--text-dim)}

/* ── Loading ── */
.loading-spinner{text-align:center;padding:40px;color:var(--text-dim);font-size:13px}
.spinner-dots{display:inline-flex;gap:4px;margin-left:8px}
.spinner-dot{
  width:4px;height:4px;background:var(--accent);border-radius:50%;
  animation:bounce 1.4s infinite;
}
.spinner-dot:nth-child(2){animation-delay:.16s}
.spinner-dot:nth-child(3){animation-delay:.32s}
@keyframes bounce{0%,80%,100%{opacity:.2}40%{opacity:1}}

/* ── Empty State ── */
.empty-state{
  text-align:center;padding:48px 16px;color:var(--text-dim);
}
.empty-state p{margin-bottom:12px;font-size:13px}

/* ── Toast ── */
.toast-container{
  position:fixed;top:12px;right:12px;z-index:50;
  display:flex;flex-direction:column;gap:8px;
}
.toast{
  background:var(--bg-elevated);border:1px solid var(--border-default);
  border-radius:var(--radius);padding:8px 12px;
  min-width:260px;max-width:360px;
  box-shadow:0 4px 16px rgba(0,0,0,.4);
  display:flex;align-items:center;gap:8px;
  transform:translateX(120%);opacity:0;
  transition:transform .2s,opacity .2s;
}
.toast.show{transform:translateX(0);opacity:1}
.toast.success{border-color:rgba(34,197,94,.3)}
.toast.error{border-color:rgba(239,68,68,.3)}
.toast.info{border-color:rgba(59,130,246,.3)}
.toast-icon{font-size:14px;flex-shrink:0}
.toast.success .toast-icon{color:rgba(34,197,94,.7)}
.toast.error .toast-icon{color:rgba(239,68,68,.7)}
.toast.info .toast-icon{color:rgba(59,130,246,.7)}
.toast-content{flex:1}
.toast-title{font-weight:600;font-size:12px;margin-bottom:1px}
.toast-message{font-size:11px;color:var(--text-muted)}
.toast-close{
  background:none;border:none;color:var(--text-dim);cursor:pointer;
  font-size:14px;padding:0;width:20px;height:20px;
}

/* ── Timeline ── */
.timeline-view{padding:16px;display:none}
.timeline-view.active{display:block}
.timeline-axis{
  position:relative;height:48px;
  background:var(--bg-elevated);border-radius:var(--radius);
  border:1px solid var(--border-subtle);
}
.timeline-session{
  position:absolute;height:20px;
  background:rgba(124,111,247,.6);border-radius:4px;
  top:14px;cursor:pointer;
  display:flex;align-items:center;padding:0 8px;
  font-size:10px;color:#fff;
  transition:opacity .15s;
}
.timeline-session:hover{opacity:.8}

/* ── Jump Button ── */
.jump-to-latest{
  position:fixed;bottom:32px;right:16px;
  background:var(--bg-elevated);color:var(--text-muted);
  border:1px solid var(--border-default);
  border-radius:50%;width:36px;height:36px;
  cursor:pointer;z-index:30;font-size:14px;
  transition:border-color .15s,color .15s;
}
.jump-to-latest:hover{border-color:var(--border-hover);color:var(--text-primary)}

/* ── Status Bar ── */
.status-bar{
  border-top:1px solid var(--border-subtle);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;height:24px;
  font-size:10px;color:var(--text-dim);
  background:var(--bg-surface);
  flex-shrink:0;
  font-variant-numeric:tabular-nums;
}
.status-left,.status-right{display:flex;gap:12px}
.ws-status{display:flex;align-items:center;gap:4px}
.ws-indicator{width:6px;height:6px;border-radius:50%;background:var(--red)}
.ws-indicator.connected{background:var(--green)}

/* ── Mobile ── */
@media(max-width:768px){
  .detail-panel{width:100vw}
  .sessions-grid{grid-template-columns:1fr!important}
  .toolbar{flex-wrap:wrap}
  .search-box{min-width:0;flex-basis:100%}
  .cost-dashboard{flex-wrap:wrap;gap:8px}
}

.hidden{display:none!important}

/* ── API Keys Modal ── */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  z-index:100;display:flex;align-items:center;justify-content:center;
  backdrop-filter:blur(4px);
}
.modal{
  background:var(--bg-surface);border:1px solid var(--border-default);
  border-radius:12px;width:580px;max-width:92vw;max-height:85vh;
  display:flex;flex-direction:column;overflow:hidden;
  box-shadow:0 16px 48px rgba(0,0,0,.5);
}
.modal-header{
  padding:16px 20px;border-bottom:1px solid var(--border-subtle);
  display:flex;justify-content:space-between;align-items:center;flex-shrink:0;
}
.modal-header h2{font-size:15px;font-weight:600;display:flex;align-items:center;gap:8px}
.modal-body{flex:1;overflow-y:auto;padding:16px 20px}
.modal-footer{
  padding:12px 20px;border-top:1px solid var(--border-subtle);
  display:flex;justify-content:flex-end;gap:8px;flex-shrink:0;
}

.key-card{
  background:var(--bg-elevated);border:1px solid var(--border-subtle);
  border-radius:var(--radius);padding:10px 14px;margin-bottom:8px;
  display:flex;align-items:center;gap:12px;
  transition:border-color .15s;
}
.key-card:hover{border-color:var(--border-default)}
.key-card.disabled{opacity:.5}
.key-drag{cursor:grab;color:var(--text-dim);font-size:16px;user-select:none}
.key-drag:active{cursor:grabbing}
.key-info{flex:1;min-width:0}
.key-name{font-size:13px;font-weight:500;color:var(--text-primary)}
.key-meta{font-size:11px;color:var(--text-dim);display:flex;gap:8px;margin-top:2px}
.key-position{
  font-size:10px;padding:1px 6px;border-radius:4px;
  background:rgba(124,111,247,.08);color:var(--accent);
  border:1px solid rgba(124,111,247,.15);font-weight:600;
}
.key-position.off{background:rgba(239,68,68,.06);color:rgba(239,68,68,.5);border-color:rgba(239,68,68,.1)}
.key-actions{display:flex;gap:4px;align-items:center}
.key-test-result{font-size:11px;margin-left:4px}
.key-toggle{
  width:36px;height:20px;background:var(--bg-surface);
  border:1px solid var(--border-default);border-radius:10px;
  cursor:pointer;position:relative;transition:background .15s;
}
.key-toggle.on{background:var(--green);border-color:var(--green)}
.key-toggle .knob{
  position:absolute;width:16px;height:16px;background:#fff;
  border-radius:50%;top:1px;left:1px;transition:transform .15s;
}
.key-toggle.on .knob{transform:translateX(16px)}
.key-move-btn{
  background:none;border:1px solid var(--border-subtle);color:var(--text-dim);
  width:24px;height:24px;border-radius:4px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:12px;
  transition:color .15s,border-color .15s;
}
.key-move-btn:hover{color:var(--text-secondary);border-color:var(--border-default)}
.key-test-btn{
  background:none;border:1px solid var(--border-subtle);color:var(--text-dim);
  padding:2px 8px;border-radius:4px;cursor:pointer;font-size:11px;
  font-family:inherit;transition:color .15s;
}
.key-test-btn:hover{color:var(--text-secondary)}

/* ── Key Usage ── */
.keys-summary{
  background:var(--bg-surface);border:1px solid var(--border-subtle);
  border-radius:var(--radius);padding:12px 16px;margin-bottom:14px;
  display:flex;gap:20px;flex-wrap:wrap;
}
.keys-summary-item{display:flex;flex-direction:column;gap:2px}
.keys-summary-label{font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px}
.keys-summary-value{font-size:15px;font-weight:600;color:var(--text-primary)}
.key-usage{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:3px}
.key-usage-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.key-usage-dot.green{background:var(--green)}
.key-usage-dot.yellow{background:var(--yellow)}
.key-usage-dot.red{background:var(--red)}
.key-usage-dot.gray{background:var(--text-dim)}
.key-usage-stat{font-size:10px;color:var(--text-muted)}
.key-usage-bar{
  height:3px;border-radius:2px;background:var(--border-subtle);
  flex:1;min-width:40px;max-width:80px;overflow:hidden;
}
.key-usage-bar-fill{height:100%;border-radius:2px;transition:width .3s}

/* ── OAuth Usage Section ── */
.oauth-section{margin-bottom:16px}
.oauth-section h3{font-size:12px;color:var(--text-secondary);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.oauth-login-btn{
  background:linear-gradient(135deg,#7c6ff7,#5b4fd6);color:#fff;
  border:none;padding:8px 16px;border-radius:var(--radius);
  cursor:pointer;font-size:13px;font-weight:500;font-family:inherit;
  transition:opacity .15s;display:flex;align-items:center;gap:6px;
}
.oauth-login-btn:hover{opacity:.85}
.oauth-code-input{
  display:flex;gap:8px;margin-top:8px;align-items:center;
}
.oauth-code-input input{
  flex:1;background:var(--bg-elevated);border:1px solid var(--border-default);
  border-radius:var(--radius);padding:6px 10px;color:var(--text-primary);
  font-size:12px;font-family:var(--font-mono);
}
.oauth-code-input input::placeholder{color:var(--text-dim)}
.oauth-code-input input:focus{outline:none;border-color:var(--accent)}
.oauth-account{
  background:var(--bg-elevated);border:1px solid var(--border-subtle);
  border-radius:var(--radius);padding:10px 14px;margin-bottom:8px;
}
.oauth-account-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.oauth-account-email{font-size:13px;font-weight:500;color:var(--text-primary);display:flex;align-items:center;gap:6px}
.oauth-account-actions{display:flex;gap:4px}
.oauth-remove-btn{
  background:none;border:1px solid rgba(239,68,68,.2);color:rgba(239,68,68,.6);
  padding:2px 8px;border-radius:4px;cursor:pointer;font-size:10px;font-family:inherit;
}
.oauth-remove-btn:hover{border-color:rgba(239,68,68,.4);color:rgba(239,68,68,.8)}
.oauth-usage-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.oauth-usage-item{display:flex;flex-direction:column;gap:4px}
.oauth-usage-label{font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:.3px;display:flex;justify-content:space-between}
.oauth-usage-bar{height:6px;background:var(--bg-base);border-radius:3px;overflow:hidden}
.oauth-usage-fill{height:100%;border-radius:3px;transition:width .5s}
.oauth-usage-value{font-size:11px;color:var(--text-secondary);font-weight:500}
.oauth-reset-time{font-size:10px;color:var(--text-dim)}
.oauth-error{font-size:11px;color:rgba(239,68,68,.7);padding:4px 0}
.oauth-extra{font-size:11px;color:var(--text-muted);margin-top:4px;padding:4px 8px;background:var(--bg-base);border-radius:4px}
</style>
</head>
<body>

<div class="toast-container" id="toastContainer"></div>

<div class="header">
  <h1>
    <div class="live-dot"></div>
    <span class="brand">OpenClaw</span> Sessions
  </h1>
  <div class="controls">
    <button class="btn" onclick="openKeysModal()" title="API Keys">&#9881; Keys</button>
    <button class="btn" id="settingsBtn" onclick="toggleSettings()">Settings</button>
    <a href="/system.html" class="btn" style="text-decoration:none">System</a>
    <button class="btn" onclick="restartGateway()" style="color:rgba(239,68,68,.7)">Restart Gateway</button>
    <button class="btn" onclick="refreshData()">Refresh</button>
  </div>
</div>

<div class="cost-dashboard">
  <div class="cost-stat">
    <div class="cost-value" id="costToday">$0.00</div>
    <div class="cost-label">today</div>
  </div>
  <div class="cost-stat">
    <div class="cost-value" id="costWeek">$0.00</div>
    <div class="cost-label">week</div>
  </div>
  <div class="cost-stat">
    <div class="cost-value" id="costMonth">$0.00</div>
    <div class="cost-label">month</div>
  </div>
  <div class="cost-stat">
    <div class="cost-value" id="activeCount">0</div>
    <div class="cost-label">active</div>
  </div>
  <div class="cost-stat">
    <div class="cost-value" id="totalSessions">0</div>
    <div class="cost-label">total</div>
  </div>
  <div class="api-keys" id="apiKeys"></div>
</div>

<div class="toolbar">
  <div class="search-box">
    <div class="search-icon">&#x1F50D;</div>
    <input type="text" class="search-input" placeholder="Search sessions... ( / )"
           id="searchInput" onkeyup="handleSearch()">
  </div>
  <div class="view-controls">
    <select class="sort-select" id="sortSelect" onchange="handleSort()">
      <option value="lastActive">Last Active</option>
      <option value="cost">Cost</option>
      <option value="name">Name</option>
      <option value="tokens">Tokens</option>
    </select>
    <button class="view-toggle active" id="gridView" onclick="setViewMode('grid')">&#x229E;</button>
    <button class="view-toggle" id="listView" onclick="setViewMode('list')">&#x2630;</button>
    <button class="view-toggle" id="timelineView" onclick="setViewMode('timeline')">&#x2261;</button>
  </div>
</div>

<div class="filter-bar">
  <button class="filter-btn active" onclick="setFilter('all', this, event)">All</button>
  <button class="filter-btn" onclick="setFilter('pinned', this, event)">Pinned</button>
  <button class="filter-btn" onclick="setFilter('running', this, event)">Running</button>
  <button class="filter-btn" onclick="setFilter('idle', this, event)">Idle</button>
  <button class="filter-btn" onclick="setFilter('group', this, event)">Groups</button>
  <button class="filter-btn" onclick="setFilter('cron', this, event)">Crons</button>
  <button class="filter-btn" onclick="setFilter('subagent', this, event)">Sub-agents</button>
  <button class="filter-btn" onclick="setFilter('main', this, event)">Main</button>
</div>

<div id="settingsPanel" class="settings-panel hidden">
  <div class="setting-row">
    <div class="setting-label">Sound Alerts</div>
    <div class="toggle-switch" id="soundToggle" onclick="toggleSetting('sound')">
      <div class="toggle-knob"></div>
    </div>
  </div>
  <div class="setting-row">
    <div class="setting-label">Toast Notifications</div>
    <div class="toggle-switch on" id="toastToggle" onclick="toggleSetting('toast')">
      <div class="toggle-knob"></div>
    </div>
  </div>
  <div class="setting-row">
    <div class="setting-label">Auto-refresh</div>
    <div class="toggle-switch on" id="autoRefreshToggle" onclick="toggleSetting('autoRefresh')">
      <div class="toggle-knob"></div>
    </div>
  </div>
</div>

<div class="main-content">
  <div class="sessions-panel">
    <div class="breadcrumb" id="breadcrumb"></div>
    <div class="timeline-view" id="timelineContainer">
      <div class="timeline" id="timeline"></div>
    </div>
    <div class="sessions-grid grid-view" id="sessionsGrid">
      <div class="loading-spinner">
        Loading sessions<span class="spinner-dots">
          <span class="spinner-dot"></span>
          <span class="spinner-dot"></span>
          <span class="spinner-dot"></span>
        </span>
      </div>
    </div>
  </div>

  <div class="detail-panel" id="detailPanel" style="display: none;">
    <div class="panel-header">
      <div class="panel-title" id="panelTitle">Select a session</div>
      <div class="panel-controls">
        <button class="btn" onclick="copyTranscript()">Copy</button>
        <button class="btn" onclick="closeDetailPanel()">&times;</button>
      </div>
    </div>
    <div class="panel-meta" id="panelMeta"></div>
    <div class="log-container" id="logContainer">
      <div class="loading-spinner">Loading transcript...</div>
    </div>
    <div class="send-bar" id="sendBar">
      <input type="text" id="sendInput" placeholder="Send a message to this session…" autocomplete="off"
        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendSessionMessage()}" />
      <button class="btn send-btn" id="sendBtn" onclick="sendSessionMessage()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
      </button>
    </div>
  </div>
</div>

<button class="jump-to-latest" id="jumpToLatest" onclick="jumpToLatest()">&darr;</button>

<div class="status-bar">
  <div class="status-left">
    <div id="sessionCount">0 sessions</div>
    <div id="lastUpdate">Never updated</div>
  </div>
  <div class="status-right">
    <div class="ws-status">
      <div class="ws-indicator" id="wsIndicator"></div>
      <span id="wsStatus">Connecting...</span>
    </div>
    <div id="keyboardHelp">? for shortcuts</div>
  </div>
</div>

<audio id="alertSound" preload="auto">
  <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAABAC..." type="audio/wav">
</audio>

<script>
// Global state
let allSessions = [];
let filteredSessions = [];
let currentFilter = 'all';
let currentSort = 'lastActive';
let currentViewMode = 'grid';
let searchTerm = '';
let selectedSession = null;
let webSocket = null;
let keyboardFocusIndex = -1;
let lastDataTimestamp = 0;  // For incremental updates
let sessionsEtag = null;    // For ETag caching
let transcriptTotal = 0;    // Total transcript entries
let transcriptOffset = 0;   // Current offset loaded
let transcriptEntries = []; // All loaded entries
let settings = {
  sound: false,
  toast: true,
  autoRefresh: true
};

// ── Virtual Scroll State ──
const CARD_HEIGHT = 80; // approximate card height in px
const CARD_GAP = 8;
const BUFFER_CARDS = 5;
let virtualScrollEnabled = false;

document.addEventListener('DOMContentLoaded', () => {
  loadSettings();
  initWebSocket();
  refreshData();
  setupKeyboardShortcuts();
  setInterval(() => { if (settings.autoRefresh) refreshData(); }, 30000);
});

function loadSettings() {
  const saved = localStorage.getItem('dashboard-settings');
  if (saved) settings = {...settings, ...JSON.parse(saved)};
  updateSettingsUI();
}

function saveSettings() {
  localStorage.setItem('dashboard-settings', JSON.stringify(settings));
}

function updateSettingsUI() {
  document.getElementById('soundToggle').classList.toggle('on', settings.sound);
  document.getElementById('toastToggle').classList.toggle('on', settings.toast);
  document.getElementById('autoRefreshToggle').classList.toggle('on', settings.autoRefresh);
}

function toggleSetting(key) {
  settings[key] = !settings[key];
  saveSettings();
  updateSettingsUI();
}

function toggleSettings() {
  document.getElementById('settingsPanel').classList.toggle('hidden');
}

function initWebSocket() {
  try {
    webSocket = new WebSocket('ws://localhost:3848');
    webSocket.onopen = () => {
      document.getElementById('wsIndicator').classList.add('connected');
      document.getElementById('wsStatus').textContent = 'Connected';
    };
    webSocket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'sessions_updated') {
        refreshData();
        if (settings.toast) showToast('info', 'Updated', 'New activity detected');
      }
    };
    webSocket.onclose = () => {
      document.getElementById('wsIndicator').classList.remove('connected');
      document.getElementById('wsStatus').textContent = 'Disconnected';
      setTimeout(initWebSocket, 5000);
    };
    webSocket.onerror = () => {
      document.getElementById('wsStatus').textContent = 'Error';
    };
  } catch (e) {
    console.warn('WebSocket not available');
  }
}

async function restartGateway() {
  if (!confirm('Restart the OpenClaw gateway?')) return;
  try {
    const r = await fetch('/api/restart-gateway', {method: 'POST'});
    const d = await r.json();
    if (d.status === 'restarting') {
      showToast('info', 'Gateway', 'Restarting OpenClaw gateway...');
    } else {
      showToast('error', 'Error', d.error || 'Failed');
    }
  } catch(e) { showToast('error', 'Error', e.message); }
}

async function refreshData(forceFullLoad) {
  try {
    // Use incremental loading after first full load
    let url = '/data/sessions.json';
    if (lastDataTimestamp && !forceFullLoad) {
      url += '?since=' + lastDataTimestamp;
    }
    
    const headers = {};
    if (sessionsEtag && !forceFullLoad) {
      headers['If-None-Match'] = '"' + sessionsEtag + '"';
    }
    
    const response = await fetch(url, { headers });
    
    // 304 Not Modified — nothing changed
    if (response.status === 304) {
      document.getElementById('lastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString() + ' (no changes)';
      return;
    }
    
    const data = await response.json();
    if (data.error) { showToast('error', 'Error', data.error); return; }
    
    // Get ETag from response
    const etag = response.headers.get('ETag');
    if (etag) sessionsEtag = etag.replace(/"/g, '');
    
    if (data.incremental) {
      // Merge incremental updates
      const updatedSessions = data.sessions || [];
      const updatedKeys = new Set(updatedSessions.map(s => s.key));
      allSessions = allSessions.map(s => {
        if (updatedKeys.has(s.key)) {
          const updated = updatedSessions.find(u => u.key === s.key);
          return updated || s;
        }
        return s;
      });
      // Add any new sessions not in allSessions
      for (const s of updatedSessions) {
        if (!allSessions.find(a => a.key === s.key)) {
          allSessions.push(s);
        }
      }
    } else {
      allSessions = data.sessions || [];
      if (data.auth) updateApiKeys(data.auth);
    }
    
    if (data.topicNames) topicNamesMap = data.topicNames;
    if (data.timestamp) lastDataTimestamp = data.timestamp;
    updateStats(data.stats || {});
    applyFiltersAndSort();
    document.getElementById('lastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString();
    document.getElementById('sessionCount').textContent = allSessions.length + ' sessions';
  } catch (error) {
    showToast('error', 'Network Error', error.message);
  }
}

function updateStats(stats) {
  document.getElementById('costToday').textContent = '$' + (stats.total_cost_today || 0).toFixed(2);
  document.getElementById('costWeek').textContent = '$' + (stats.total_cost_week || 0).toFixed(2);
  document.getElementById('costMonth').textContent = '$' + (stats.total_cost_month || 0).toFixed(2);
  document.getElementById('activeCount').textContent = stats.active_sessions || 0;
  document.getElementById('totalSessions').textContent = allSessions.length;
}

function updateApiKeys(auth) {
  const container = document.getElementById('apiKeys');
  const order = auth.order || {};
  let html = '';
  for (const [provider, keys] of Object.entries(order)) {
    for (let i = 0; i < keys.length; i++) {
      const keyName = keys[i].replace(provider + ':', '');
      const isActive = i === 0;
      html += `<div class="api-key ${isActive ? 'active' : ''}">
        <div class="key-status" style="${isActive ? '' : 'background:var(--text-dim)'}"></div>
        ${keyName}
      </div>`;
    }
  }
  container.innerHTML = html;
}

function setFilter(filter, button, event) {
  if (event) event.stopPropagation();
  currentFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  button.classList.add('active');
  applyFiltersAndSort();
}

function handleSort() {
  currentSort = document.getElementById('sortSelect').value;
  applyFiltersAndSort();
}

function handleSearch() {
  searchTerm = document.getElementById('searchInput').value.toLowerCase();
  applyFiltersAndSort();
}

function applyFiltersAndSort() {
  let sessions = [...allSessions];
  if (searchTerm) {
    sessions = sessions.filter(s =>
      (getSessionName(s).toLowerCase().includes(searchTerm)) ||
      (s.key.toLowerCase().includes(searchTerm)) ||
      (s.sessionId && s.sessionId.toLowerCase().includes(searchTerm))
    );
  }
  if (currentFilter !== 'all') {
    sessions = sessions.filter(s => {
      switch (currentFilter) {
        case 'pinned': return s.pinned;
        case 'running': return s.status === 'running';
        case 'idle': return s.status === 'idle';
        case 'group': return s.sessionType === 'telegram' || s.sessionType === 'group';
        case 'cron': return s.sessionType === 'cron' || s.sessionType === 'cron-run';
        case 'subagent': return s.sessionType === 'subagent';
        case 'main': return s.sessionType === 'main';
        default: return true;
      }
    });
  }
  sessions.sort((a, b) => {
    switch (currentSort) {
      case 'lastActive': return (b.updatedAt || 0) - (a.updatedAt || 0);
      case 'name': return getSessionName(a).localeCompare(getSessionName(b));
      case 'cost': return getTotalCost(b) - getTotalCost(a);
      case 'tokens': return getTotalTokens(b) - getTotalTokens(a);
      default: return 0;
    }
  });
  if (currentFilter !== 'pinned') {
    const pinned = sessions.filter(s => s.pinned);
    const unpinned = sessions.filter(s => !s.pinned);
    sessions = [...pinned, ...unpinned];
  }
  filteredSessions = sessions;
  renderSessions();
}

function setViewMode(mode) {
  currentViewMode = mode;
  document.querySelectorAll('.view-toggle').forEach(b => b.classList.remove('active'));
  document.getElementById(mode + 'View').classList.add('active');
  const grid = document.getElementById('sessionsGrid');
  const timeline = document.getElementById('timelineContainer');
  if (mode === 'timeline') {
    grid.style.display = 'none';
    timeline.classList.add('active');
    renderTimeline();
  } else {
    grid.style.display = 'grid';
    timeline.classList.remove('active');
    grid.className = `sessions-grid ${mode}-view`;
    renderSessions();
  }
}

function renderSessions() {
  const container = document.getElementById('sessionsGrid');
  if (!filteredSessions.length) {
    container.innerHTML = '<div class="empty-state"><p>No sessions match your criteria</p><button class="btn" onclick="setFilter(\'all\', document.querySelector(\'.filter-btn\'));document.querySelector(\'.filter-btn\').classList.add(\'active\')">Show all sessions</button></div>';
    return;
  }
  
  // Virtual scrolling for large lists
  if (filteredSessions.length > 50 && currentViewMode === 'list') {
    setupVirtualScroll(container);
  } else {
    // For grid view or small lists, render all (with documentFragment for perf)
    teardownVirtualScroll();
    const fragment = document.createDocumentFragment();
    const tmp = document.createElement('div');
    tmp.innerHTML = filteredSessions.map((session, index) => createSessionCard(session, index)).join('');
    while (tmp.firstChild) fragment.appendChild(tmp.firstChild);
    container.innerHTML = '';
    container.appendChild(fragment);
  }
}

function setupVirtualScroll(container) {
  virtualScrollEnabled = true;
  const totalHeight = filteredSessions.length * (CARD_HEIGHT + CARD_GAP);
  const scrollParent = container.closest('.sessions-panel');
  
  container.innerHTML = '';
  container.style.position = 'relative';
  container.style.height = totalHeight + 'px';
  container.style.minHeight = totalHeight + 'px';
  
  const renderVisible = () => {
    const scrollTop = scrollParent.scrollTop;
    const viewHeight = scrollParent.clientHeight;
    const startIdx = Math.max(0, Math.floor(scrollTop / (CARD_HEIGHT + CARD_GAP)) - BUFFER_CARDS);
    const endIdx = Math.min(filteredSessions.length, Math.ceil((scrollTop + viewHeight) / (CARD_HEIGHT + CARD_GAP)) + BUFFER_CARDS);
    
    // Remove out-of-view cards
    const existing = container.querySelectorAll('.session-card');
    existing.forEach(card => {
      const idx = parseInt(card.dataset.index);
      if (idx < startIdx || idx >= endIdx) card.remove();
    });
    
    // Add missing cards
    const existingIndices = new Set(Array.from(container.querySelectorAll('.session-card')).map(c => parseInt(c.dataset.index)));
    const fragment = document.createDocumentFragment();
    for (let i = startIdx; i < endIdx; i++) {
      if (existingIndices.has(i)) continue;
      const tmp = document.createElement('div');
      tmp.innerHTML = createSessionCard(filteredSessions[i], i);
      const card = tmp.firstElementChild;
      card.style.position = 'absolute';
      card.style.top = (i * (CARD_HEIGHT + CARD_GAP)) + 'px';
      card.style.left = '0';
      card.style.right = '0';
      fragment.appendChild(card);
    }
    container.appendChild(fragment);
  };
  
  renderVisible();
  scrollParent._virtualScrollHandler = renderVisible;
  scrollParent.addEventListener('scroll', renderVisible, { passive: true });
}

function teardownVirtualScroll() {
  if (!virtualScrollEnabled) return;
  virtualScrollEnabled = false;
  const container = document.getElementById('sessionsGrid');
  const scrollParent = container.closest('.sessions-panel');
  if (scrollParent._virtualScrollHandler) {
    scrollParent.removeEventListener('scroll', scrollParent._virtualScrollHandler);
    delete scrollParent._virtualScrollHandler;
  }
  container.style.position = '';
  container.style.height = '';
  container.style.minHeight = '';
}

function createSessionCard(session, index) {
  const name = getSessionName(session);
  const status = session.status || 'completed';
  const type = session.sessionType || 'other';
  const isPinned = session.pinned;
  const hasChildren = session.childCount > 0;
  const totalCost = getTotalCost(session);
  const tokensIn = getTokensIn(session);
  const tokensOut = getTokensOut(session);
  const totalTokensCalc = tokensIn + tokensOut;
  const inPercent = totalTokensCalc ? (tokensIn / totalTokensCalc) * 100 : 0;
  const outPercent = totalTokensCalc ? (tokensOut / totalTokensCalc) * 100 : 0;
  const model = getLastModel(session);

  const activity = session.activity || [];
  const activityHtml = activity.slice(0, 3).map(act => `
    <div class="activity-item">
      <span class="activity-action">${act.action || '—'}</span>
      ${act.detail ? `<span class="activity-detail">${escapeHtml(act.detail)}</span>` : ''}
      <span class="activity-time">${formatTime(act.ts)}</span>
    </div>
  `).join('');

  const childrenHtml = hasChildren ? `
    <div class="children-section" id="children-${index}">
      <div class="children-toggle" onclick="toggleChildren(${index})">
        <div class="children-label">${session.childCount} ${getChildrenLabel(session)}</div>
        <div class="expand-icon">&#9654;</div>
      </div>
      <div class="children-list">
        ${(session.children || []).slice(0, 5).map(child => `
          <div class="child-item" onclick="openSession('${escapeHtml(child.key)}', event)">
            <div style="display:flex;align-items:center;gap:4px">
              <span class="status-dot status-${getChildStatus(child)}"></span>
              <span>${getChildName(child)}</span>
            </div>
            <span style="font-size:10px;color:var(--text-dim)">${formatTime(child.updatedAt)}</span>
          </div>
        `).join('')}
        ${session.childCount > 5 ? `<div style="font-size:10px;color:var(--text-dim);padding:4px 8px">+${session.childCount - 5} more</div>` : ''}
      </div>
    </div>
  ` : '';

  return `
    <div class="session-card" data-index="${index}" onclick="openSession('${escapeHtml(session.key)}', event)">
      <div class="card-header">
        <div class="card-title">
          <div class="status-dot status-${status}"></div>
          <div class="card-name">${escapeHtml(name)}</div>
        </div>
        <div class="card-badges">
          ${model ? `<div class="model-pill">${escapeHtml(model)}</div>` : ''}
          <div class="badge badge-${type}">${formatBadgeLabel(type)}</div>
          <button class="pin-btn ${isPinned ? 'pinned' : ''}" onclick="togglePin('${escapeHtml(session.key)}', event)">
            ${isPinned ? '&#9733;' : '&#9734;'}
          </button>
        </div>
      </div>
      <div class="card-meta">
        <span>${session.channel || '—'}</span>
        <span>${formatTime(session.updatedAt)} ago</span>
        <span>${session.sessionId ? session.sessionId.slice(0, 8) : '—'}</span>
      </div>
      ${totalTokensCalc ? `
        <div class="token-summary">
          <div class="token-bar">
            <div class="token-fill-in" style="width:${inPercent}%"></div>
            <div class="token-fill-out" style="width:${outPercent}%"></div>
          </div>
          <div class="token-text">${tokensIn}&#8594;${tokensOut}</div>
          ${totalCost > 0 ? `<div class="cost-display">$${totalCost.toFixed(3)}</div>` : ''}
        </div>
      ` : ''}
      ${activityHtml ? `<div class="activity-section">${activityHtml}</div>` : ''}
      ${childrenHtml}
    </div>
  `;
}

function renderTimeline() {
  const container = document.getElementById('timeline');
  const now = Date.now();
  const dayAgo = now - 86400000;
  const activeSessions = filteredSessions.filter(s => s.updatedAt > dayAgo);
  if (!activeSessions.length) {
    container.innerHTML = '<div class="empty-state"><p>No recent activity</p></div>';
    return;
  }
  const timelineHtml = activeSessions.map(session => {
    const startTime = Math.max(session.updatedAt - 7200000, dayAgo);
    const endTime = session.updatedAt;
    const leftPercent = ((startTime - dayAgo) / (now - dayAgo)) * 100;
    const widthPercent = ((endTime - startTime) / (now - dayAgo)) * 100;
    return `<div class="timeline-session" style="left:${leftPercent}%;width:${Math.max(widthPercent, 2)}%"
      onclick="openSession('${escapeHtml(session.key)}', event)"
      title="${escapeHtml(getSessionName(session))}">${escapeHtml(getSessionName(session)).slice(0, 20)}</div>`;
  }).join('');
  container.innerHTML = `<div class="timeline-axis">${timelineHtml}</div>`;
}

async function openSession(sessionKey, event) {
  if (event) event.stopPropagation();
  const session = allSessions.find(s => s.key === sessionKey);
  if (!session || !session.sessionId) {
    showToast('error', 'Error', 'Session not found');
    return;
  }
  selectedSession = session;
  updateBreadcrumb(session);
  document.getElementById('detailPanel').style.display = 'flex';
  document.getElementById('panelTitle').textContent = getSessionName(session);
  const meta = document.getElementById('panelMeta');
  meta.innerHTML = `
    <span>${session.channel || '—'}</span>
    <span>${session.sessionId.slice(0, 8)}</span>
    <span>${formatTime(session.updatedAt)} ago</span>
    <span class="badge badge-${session.sessionType || 'other'}">${formatBadgeLabel(session.sessionType || 'other')}</span>
    ${session.status === 'running' ? '<span style="color:rgba(34,197,94,.7)">live</span>' : ''}
  `;
  await loadTranscript(session.sessionId);
  // Start live polling for transcript
  if (window._transcriptInterval) clearInterval(window._transcriptInterval);
  window._transcriptInterval = setInterval(() => {
    if (selectedSession && selectedSession.sessionId) {
      refreshTranscript(selectedSession.sessionId);
    }
  }, 3000);
}

function closePanel() {
  document.getElementById('detailPanel').style.display = 'none';
  selectedSession = null;
  if (window._transcriptInterval) { clearInterval(window._transcriptInterval); window._transcriptInterval = null; }
}

async function refreshTranscript(sessionId) {
  // Don't refresh if panel is hidden
  const panel = document.getElementById('detailPanel');
  if (!panel || panel.style.display === 'none') return;
  
  try {
    // Only fetch last 100 entries for refresh (we already have older ones)
    const response = await fetch(`/data/transcript/${sessionId}?limit=100`);
    const data = await response.json();
    if (data.error || !data.entries) return;
    const container = document.getElementById('logContainer');
    const wasAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 100;
    
    const newTotal = data.total || 0;
    if (newTotal !== transcriptTotal) {
      // Merge: keep older loaded entries, replace tail with fresh data
      const oldPrefix = transcriptEntries.slice(0, transcriptEntries.length - (transcriptTotal - (data.offset || 0)));
      transcriptEntries = [...oldPrefix, ...data.entries];
      transcriptTotal = newTotal;
      renderTranscript(transcriptEntries);
      if (wasAtBottom) container.scrollTop = container.scrollHeight;
    }
  } catch(e) {}
}

function updateBreadcrumb(session) {
  const breadcrumb = document.getElementById('breadcrumb');
  const parts = [{name: 'Main', key: 'main'}];
  if (session.parentKey && session.parentLabel) parts.push({name: session.parentLabel, key: session.parentKey});
  parts.push({name: getSessionName(session), key: session.key});
  breadcrumb.innerHTML = parts.map((part, i) =>
    `${i > 0 ? '<span class="breadcrumb-separator">&#8250;</span>' : ''}
     <span class="breadcrumb-item" onclick="${part.key !== session.key ? `navigateTo('${escapeHtml(part.key)}')` : ''}">${escapeHtml(part.name)}</span>`
  ).join('');
}

function navigateTo(sessionKey) { openSession(sessionKey); }

async function loadTranscript(sessionId) {
  const container = document.getElementById('logContainer');
  container.innerHTML = '<div class="loading-spinner">Loading transcript...</div>';
  transcriptEntries = [];
  transcriptTotal = 0;
  transcriptOffset = 0;
  try {
    const response = await fetch(`/data/transcript/${sessionId}?limit=100`);
    const data = await response.json();
    if (data.error) { container.innerHTML = `<div class="loading-spinner">${data.error}</div>`; return; }
    transcriptEntries = data.entries || [];
    transcriptTotal = data.total || transcriptEntries.length;
    transcriptOffset = data.offset || 0;
    renderTranscript(transcriptEntries);
    
    // Setup scroll-up to load more
    if (transcriptOffset > 0) {
      setupTranscriptInfiniteScroll(sessionId, container);
    }
  } catch (error) {
    container.innerHTML = `<div class="loading-spinner">Failed: ${error.message}</div>`;
  }
}

let _loadingMore = false;
function setupTranscriptInfiniteScroll(sessionId, container) {
  container._loadMoreHandler = async () => {
    if (_loadingMore || transcriptOffset <= 0 || container.scrollTop > 100) return;
    _loadingMore = true;
    const prevHeight = container.scrollHeight;
    const loadOffset = Math.max(0, transcriptOffset - 100);
    const loadLimit = transcriptOffset - loadOffset;
    try {
      const r = await fetch(`/data/transcript/${sessionId}?offset=${loadOffset}&limit=${loadLimit}`);
      const d = await r.json();
      if (d.entries && d.entries.length) {
        transcriptEntries = [...d.entries, ...transcriptEntries];
        transcriptOffset = loadOffset;
        renderTranscript(transcriptEntries);
        // Maintain scroll position
        container.scrollTop = container.scrollHeight - prevHeight;
        if (transcriptOffset <= 0) {
          container.removeEventListener('scroll', container._loadMoreHandler);
        }
      }
    } catch(e) {}
    _loadingMore = false;
  };
  container.addEventListener('scroll', container._loadMoreHandler, { passive: true });
}

function renderTranscript(entries) {
  const container = document.getElementById('logContainer');
  if (!entries.length) { container.innerHTML = '<div class="empty-state"><p>No entries</p></div>'; return; }

  const resultMap = {};
  entries.forEach(entry => {
    (entry.content || []).forEach(c => { if (c.type === 'result' && c.id) resultMap[c.id] = c; });
  });
  const renderedResults = new Set();

  const html = entries.map(entry => {
    const role = entry.role || 'system';
    let contentHtml = '';
    (entry.content || []).forEach(c => {
      if (c.type === 'tool') {
        const result = resultMap[c.id];
        let resultHtml;
        if (result) {
          renderedResults.add(c.id);
          resultHtml = `<div class="tool-content">
            <div class="tool-args">${escapeHtml(JSON.stringify(c.args || {}, null, 2))}</div>
            <div class="tool-result">
              <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                <span style="color:rgba(34,197,94,.6);font-weight:600;font-size:10px">RESULT</span>
                <button class="copy-btn" onclick="copyText('${escapeHtml(result.text || '')}')">copy</button>
              </div>
              ${escapeHtml(result.text || '(empty)')}
            </div>
          </div>`;
        } else {
          resultHtml = `<div class="tool-content">
            <div class="tool-args">${escapeHtml(JSON.stringify(c.args || {}, null, 2))}</div>
            <div class="tool-pending">Waiting for result...</div>
          </div>`;
        }
        contentHtml += `<div class="tool-call" onclick="toggleToolCall(this)">
          <div class="tool-header">
            <div class="tool-name">${escapeHtml(c.name)}</div>
            <div class="tool-toggle">&#9660;</div>
          </div>
          ${resultHtml}
        </div>`;
      } else if (c.type === 'result' && !renderedResults.has(c.id)) {
        contentHtml += `<div class="tool-call expanded">
          <div class="tool-header">
            <div class="tool-name">${escapeHtml(c.name)}</div>
            <button class="copy-btn" onclick="copyText('${escapeHtml(c.text || '')}')">copy</button>
          </div>
          <div class="tool-content"><div class="tool-result">${escapeHtml(c.text || '(empty)')}</div></div>
        </div>`;
      } else if (c.type === 'text') {
        contentHtml += `<div class="log-text">${marked.parse(c.text || '')}</div>
          <button class="copy-btn" onclick="copyText('${escapeHtml(c.text || '')}')">copy</button>`;
      } else if (c.type === 'image') {
        contentHtml += `<img class="image-preview" src="${escapeHtml(c.url)}"
          onclick="window.open('${escapeHtml(c.url)}','_blank')"
          onerror="this.outerHTML='<span style=color:var(--text-dim)>Image: '+this.src+'</span>'" />`;
      } else if (c.type === 'thinking') {
        contentHtml += `<div class="thinking-block">${escapeHtml(c.text)}</div>`;
      }
    });
    if (!contentHtml.trim()) return '';
    const metaHtml = [];
    if (entry.model) metaHtml.push(`<span class="log-model">${entry.model}</span>`);
    if (entry.cost > 0) metaHtml.push(`<span class="log-cost">$${entry.cost.toFixed(4)}</span>`);
    if (entry.tokens && (entry.tokens.in || entry.tokens.out)) {
      metaHtml.push(`<span class="log-tokens">${entry.tokens.in}&#8594;${entry.tokens.out}</span>`);
      if (entry.tokens.cache) metaHtml.push(`<span class="log-tokens">${entry.tokens.cache} cached</span>`);
    }
    return `<div class="log-entry role-${role}">
      <div class="log-header">
        <div class="log-role role-${role}">${role.toUpperCase()}</div>
        <div class="log-timestamp">${formatTimestamp(entry.ts)}</div>
      </div>
      ${contentHtml}
      ${metaHtml.length ? `<div class="log-meta">${metaHtml.join(' ')}</div>` : ''}
    </div>`;
  }).filter(h => h).join('');

  container.innerHTML = html;
  setTimeout(() => { container.scrollTop = container.scrollHeight; }, 100);
}

function closeDetailPanel() {
  document.getElementById('detailPanel').style.display = 'none';
  selectedSession = null;
  document.getElementById('breadcrumb').innerHTML = '';
  if (window._transcriptInterval) { clearInterval(window._transcriptInterval); window._transcriptInterval = null; }
}

function toggleChildren(index) {
  const section = document.getElementById(`children-${index}`);
  if (section) {
    section.classList.toggle('expanded');
    const card = section.closest('.session-card');
    card.classList.toggle('expanded');
  }
}

function toggleToolCall(element) { element.classList.toggle('expanded'); }

function togglePin(sessionKey, event) {
  event.stopPropagation();
  const session = allSessions.find(s => s.key === sessionKey);
  if (!session) return;
  const action = session.pinned ? 'unpin' : 'pin';
  fetch('/api/pin', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({sessionKey, action})
  }).then(response => {
    if (response.ok) {
      session.pinned = !session.pinned;
      applyFiltersAndSort();
      showToast('success', 'Done', `Session ${action}ned`);
    }
  }).catch(() => showToast('error', 'Error', 'Failed to update pin'));
}

function jumpToLatest() {
  document.getElementById('logContainer').scrollTop = document.getElementById('logContainer').scrollHeight;
}

function copyText(text) {
  navigator.clipboard.writeText(text).then(() => showToast('success', 'Copied', 'Text copied'))
    .catch(() => showToast('error', 'Error', 'Failed to copy'));
}

function copyTranscript() {
  if (!selectedSession) return;
  const els = document.querySelectorAll('#logContainer .log-text, #logContainer .tool-result');
  copyText(Array.from(els).map(el => el.textContent).join('\n\n'));
}

async function sendSessionMessage() {
  if (!selectedSession) return;
  const input = document.getElementById('sendInput');
  const btn = document.getElementById('sendBtn');
  const message = input.value.trim();
  if (!message) return;
  btn.disabled = true;
  input.disabled = true;
  try {
    const res = await fetch('/api/send-message', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ sessionId: selectedSession.sessionId, message })
    });
    const data = await res.json();
    if (res.ok && data.status === 'sent') {
      input.value = '';
      showToast('success', 'Sent', 'Message sent to session');
      setTimeout(() => refreshTranscript(selectedSession.sessionId), 1500);
    } else {
      showToast('error', 'Failed', data.error || 'Could not send message');
    }
  } catch (e) {
    showToast('error', 'Error', e.message);
  } finally {
    btn.disabled = false;
    input.disabled = false;
    input.focus();
  }
}

function showToast(type, title, message) {
  if (!settings.toast) return;
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  const icons = {success: '&#10003;', error: '&#10007;', info: '&#8226;'};
  toast.innerHTML = `
    <div class="toast-icon">${icons[type] || '&#8226;'}</div>
    <div class="toast-content">
      <div class="toast-title">${title}</div>
      <div class="toast-message">${message}</div>
    </div>
    <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
  `;
  container.appendChild(toast);
  setTimeout(() => toast.classList.add('show'), 16);
  setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 200); }, 5000);
  if (settings.sound && type === 'error') {
    try { document.getElementById('alertSound').play(); } catch (e) {}
  }
}

function setupKeyboardShortcuts() {
  document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      if (e.key === 'Escape') e.target.blur();
      return;
    }
    switch (e.key) {
      case '/': e.preventDefault(); document.getElementById('searchInput').focus(); break;
      case 'Escape': closeDetailPanel(); break;
      case 'r': refreshData(); break;
      case 'j': navigateKeyboard(1); break;
      case 'k': navigateKeyboard(-1); break;
      case 'Enter':
        if (keyboardFocusIndex >= 0 && keyboardFocusIndex < filteredSessions.length)
          openSession(filteredSessions[keyboardFocusIndex].key);
        break;
      case '?': showKeyboardHelp(); break;
    }
  });
}

function navigateKeyboard(direction) {
  const cards = document.querySelectorAll('.session-card');
  cards.forEach(card => card.classList.remove('keyboard-focus'));
  keyboardFocusIndex += direction;
  if (keyboardFocusIndex < 0) keyboardFocusIndex = filteredSessions.length - 1;
  if (keyboardFocusIndex >= filteredSessions.length) keyboardFocusIndex = 0;
  if (keyboardFocusIndex >= 0 && keyboardFocusIndex < cards.length) {
    const card = cards[keyboardFocusIndex];
    card.classList.add('keyboard-focus');
    card.scrollIntoView({behavior: 'smooth', block: 'center'});
  }
}

function showKeyboardHelp() {
  showToast('info', 'Shortcuts', 'j/k: Navigate · Enter: Open · /: Search · r: Refresh · Esc: Close');
}

let topicNamesMap = {};

function getSessionName(session) {
  if (session.label) return session.label;
  const topicMatch = session.key.match(/topic:(\d+)/);
  if (topicMatch) {
    const topicId = topicMatch[1];
    const topicName = topicNamesMap[topicId];
    if (topicName) return topicName;
    return session.subject ? `${session.subject} #${topicId}` : `Topic ${topicId}`;
  }
  if (session.subject) return session.subject;
  if (session.displayName) return session.displayName.replace('telegram:', '').replace('g-', 'Group ');
  if (session.key.includes(':main:main')) return 'Main DM';
  const cronMatch = session.key.match(/cron:(.{8})/);
  if (cronMatch) return `Cron ${cronMatch[1]}`;
  return session.key.split(':').slice(-2).join(':');
}

function formatBadgeLabel(type) {
  const labels = {main:'main',group:'group',telegram:'telegram',cron:'cron','cron-run':'run',subagent:'sub-agent',other:'other'};
  return labels[type] || type;
}

function formatTime(timestamp) {
  if (!timestamp) return '—';
  const ts = typeof timestamp === 'string' ? new Date(timestamp).getTime() : timestamp;
  const diff = Date.now() - ts;
  if (diff < 0) return 'now';
  const seconds = Math.floor(diff / 1000);
  if (seconds < 60) return seconds + 's';
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return minutes + 'm';
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return hours + 'h';
  return Math.floor(hours / 24) + 'd';
}

function formatTimestamp(timestamp) {
  if (!timestamp) return '';
  return new Date(typeof timestamp === 'number' ? timestamp : timestamp).toLocaleString();
}

function getTotalCost(session) {
  return (session.activity || []).reduce((t, a) => t + (a.cost || 0), 0);
}
function getTotalTokens(session) { return getTokensIn(session) + getTokensOut(session); }
function getTokensIn(session) { return (session.activity || []).reduce((t, a) => t + (a.tokens?.in || 0), 0); }
function getTokensOut(session) { return (session.activity || []).reduce((t, a) => t + (a.tokens?.out || 0), 0); }

function getLastModel(session) {
  const activity = session.activity || [];
  for (let i = activity.length - 1; i >= 0; i--) { if (activity[i].model) return activity[i].model; }
  return null;
}

function getChildrenLabel(session) {
  const children = session.children || [];
  const hasSubagents = children.some(c => c.key && c.key.includes(':subagent:'));
  const hasCronRuns = children.some(c => c.key && c.key.includes(':run:'));
  if (hasSubagents && hasCronRuns) return 'children';
  if (hasSubagents) return session.childCount > 1 ? 'sub-agents' : 'sub-agent';
  return session.childCount > 1 ? 'runs' : 'run';
}

function getChildName(child) {
  if (child.label) return child.label;
  if (child.sessionId) return child.sessionId.slice(0, 8);
  return child.key ? child.key.split(':').pop() : '—';
}

function getChildStatus(child) {
  const age = Date.now() - (child.updatedAt || 0);
  if (age < 300000) return 'running';
  if (age < 3600000) return 'idle';
  return 'completed';
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ── API Keys Modal ──
let keysData = [];
let keysTestResults = {};
let keysUsageData = {};
let oauthAccounts = {};  // {email: {ok, usage, error, ...}}
let oauthPending = null; // {sessionId, authUrl}
let oauthRefreshInterval = null;

async function openKeysModal() {
  await Promise.all([loadKeysData(), loadKeysUsage(), loadOAuthUsage()]);
  renderKeysModal();
  // Auto-refresh OAuth usage every 60s while modal is open
  if (oauthRefreshInterval) clearInterval(oauthRefreshInterval);
  oauthRefreshInterval = setInterval(async () => {
    if (!document.getElementById('keysModal')) { clearInterval(oauthRefreshInterval); return; }
    await loadOAuthUsage();
    renderKeysModal();
  }, 60000);
}

async function loadKeysData() {
  try {
    const r = await fetch('/api/keys?t=' + Date.now());
    const d = await r.json();
    keysData = d.keys || [];
    window._allKeyProfiles = keysData.map(k => k.name);
  } catch(e) { showToast('error', 'Error', e.message); }
}

async function loadKeysUsage() {
  try {
    const r = await fetch('/api/keys/usage?t=' + Date.now());
    keysUsageData = await r.json();
  } catch(e) { keysUsageData = {}; }
}

function timeAgo(ts) {
  if (!ts) return 'never';
  const diff = Date.now() - ts;
  if (diff < 60000) return Math.floor(diff/1000) + 's ago';
  if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
  return Math.floor(diff/86400000) + 'd ago';
}

function renderKeysModal() {
  let existing = document.getElementById('keysModal');
  if (existing) existing.remove();

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.id = 'keysModal';
  overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };

  const enabled = keysData.filter(k => k.enabled).sort((a,b) => a.position - b.position);
  const disabled = keysData.filter(k => !k.enabled);

  const renderCard = (key, idx, isEnabled) => {
    const testRes = keysTestResults[key.name];
    let testHtml = '';
    if (testRes === 'testing') testHtml = '<span class="key-test-result" style="color:var(--yellow)">⏳</span>';
    else if (testRes && testRes.ok && testRes.oauth) testHtml = `<span class="key-test-result" style="color:var(--green)" title="${escapeHtml(testRes.note||'OAuth OK')}">✅🔑</span>`;
    else if (testRes && testRes.ok) testHtml = `<span class="key-test-result" style="color:var(--green)" title="${escapeHtml(testRes.model||'')}">✅</span>`;
    else if (testRes && !testRes.ok) testHtml = `<span class="key-test-result" style="color:var(--red)" title="${escapeHtml(testRes.error||'')}">❌</span>`;

    const shortName = key.name.replace(key.provider + ':', '');
    const usage = (keysUsageData.keys || {})[key.name] || {};
    const statusColor = usage.status === 'active' ? 'green' : usage.status === 'error' ? 'red' : usage.status === 'idle' ? 'yellow' : 'gray';
    const lastActive = usage.lastUsed ? timeAgo(usage.lastUsed) : 'never';
    const errCount = usage.errorCount || 0;

    // Relative usage bar: based on recency (more recent = more filled)
    const recency = usage.lastUsed ? Math.max(0, 100 - Math.min(100, (Date.now() - usage.lastUsed) / 36000)) : 0; // 1hr = 0%

    let usageHtml = `<div class="key-usage">
      <span class="key-usage-dot ${statusColor}"></span>
      <span class="key-usage-stat">${lastActive}</span>
      <div class="key-usage-bar"><div class="key-usage-bar-fill" style="width:${Math.round(recency)}%;background:var(--${statusColor})"></div></div>
      ${errCount > 0 ? `<span class="key-usage-stat" style="color:var(--red)">${errCount} err</span>` : ''}
    </div>`;

    return `<div class="key-card ${isEnabled ? '' : 'disabled'}" data-key="${escapeHtml(key.name)}">
      <div class="key-drag" title="Drag to reorder">⠿</div>
      <div class="key-info">
        <div class="key-name">${escapeHtml(shortName)}</div>
        <div class="key-meta">
          <span>${key.provider}</span>
          <span>${key.mode}</span>
        </div>
        ${usageHtml}
      </div>
      <span class="key-position ${isEnabled ? '' : 'off'}">${isEnabled ? '#' + (key.position + 1) : 'OFF'}</span>
      ${testHtml}
      <div class="key-actions">
        <button class="key-test-btn" onclick="testKey('${escapeHtml(key.name)}')">Test</button>
        ${isEnabled ? `<button class="key-move-btn" onclick="moveKey('${escapeHtml(key.name)}',-1)" ${idx===0?'disabled':''}>▲</button>
        <button class="key-move-btn" onclick="moveKey('${escapeHtml(key.name)}',1)" ${idx===enabled.length-1?'disabled':''}>▼</button>` : ''}
        <div class="key-toggle ${isEnabled ? 'on' : ''}" onclick="toggleKey('${escapeHtml(key.name)}', ${!isEnabled})">
          <div class="knob"></div>
        </div>
      </div>
    </div>`;
  };

  const summary = keysUsageData.summary || {};
  const summaryHtml = `<div class="keys-summary">
    <div class="keys-summary-item"><span class="keys-summary-label">Active</span><span class="keys-summary-value">${summary.activeKeys||0}/${summary.totalKeys||0}</span></div>
    <div class="keys-summary-item"><span class="keys-summary-label">Errors</span><span class="keys-summary-value" ${(summary.totalErrors||0)>0?'style="color:var(--red)"':''}>${summary.totalErrors||0}</span></div>
    <div class="keys-summary-item"><span class="keys-summary-label">Last Rotation</span><span class="keys-summary-value" style="font-size:12px">${summary.lastRotation ? timeAgo(summary.lastRotation) : '—'}</span></div>
  </div>`;

  const oauthHtml = renderOAuthSection();

  overlay.innerHTML = `<div class="modal">
    <div class="modal-header">
      <h2>&#9881; API Keys</h2>
      <button class="btn" onclick="if(oauthRefreshInterval)clearInterval(oauthRefreshInterval);document.getElementById('keysModal').remove()">&times;</button>
    </div>
    <div class="modal-body">
      ${oauthHtml}
      ${summaryHtml}
      ${enabled.map((k,i) => renderCard(k, i, true)).join('')}
      ${disabled.length ? '<div style="font-size:11px;color:var(--text-dim);margin:12px 0 4px;text-transform:uppercase;letter-spacing:1px">Disabled</div>' : ''}
      ${disabled.map((k,i) => renderCard(k, i, false)).join('')}
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="testAllKeys()">Test All</button>
      <button class="btn" onclick="if(oauthRefreshInterval)clearInterval(oauthRefreshInterval);document.getElementById('keysModal').remove()">Close</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
}

async function toggleKey(name, enabled) {
  try {
    await fetch('/api/keys/toggle', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({profileName: name, enabled})
    });
    await loadKeysData();
    renderKeysModal();
    refreshData();
  } catch(e) { showToast('error','Error',e.message); }
}

async function moveKey(name, direction) {
  const key = keysData.find(k => k.name === name);
  if (!key) return;
  const provider = key.provider;
  const ordered = keysData.filter(k => k.enabled && k.provider === provider).sort((a,b) => a.position - b.position);
  const idx = ordered.findIndex(k => k.name === name);
  const newIdx = idx + direction;
  if (newIdx < 0 || newIdx >= ordered.length) return;
  [ordered[idx], ordered[newIdx]] = [ordered[newIdx], ordered[idx]];
  const newOrder = ordered.map(k => k.name);
  try {
    await fetch('/api/keys/reorder', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({provider, order: newOrder})
    });
    await loadKeysData();
    renderKeysModal();
    refreshData();
  } catch(e) { showToast('error','Error',e.message); }
}

async function testKey(name) {
  keysTestResults[name] = 'testing';
  renderKeysModal();
  try {
    const r = await fetch('/api/keys/test', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({profileName: name})
    });
    const d = await r.json();
    keysTestResults[name] = d[name] || {ok: false, error: 'Unknown'};
  } catch(e) { keysTestResults[name] = {ok: false, error: e.message}; }
  renderKeysModal();
}

async function testAllKeys() {
  keysData.forEach(k => { keysTestResults[k.name] = 'testing'; });
  renderKeysModal();
  try {
    const r = await fetch('/api/keys/test-all', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: '{}'
    });
    const d = await r.json();
    Object.assign(keysTestResults, d);
  } catch(e) { showToast('error','Error',e.message); }
  renderKeysModal();
}

// ── OAuth Functions ──
async function loadOAuthUsage() {
  try {
    const r = await fetch('/api/keys/oauth/usage?t=' + Date.now());
    oauthAccounts = await r.json();
  } catch(e) { oauthAccounts = {}; }
}

async function startOAuthLogin() {
  try {
    const r = await fetch('/api/keys/oauth/start', {method:'POST'});
    const d = await r.json();
    if (d.error) { showToast('error','OAuth Error', d.error); return; }
    oauthPending = {...d, step: 'code'};
    window.open(d.authUrl, '_blank');
    renderKeysModal();
  } catch(e) { showToast('error','Error',e.message); }
}

async function completeOAuthLogin() {
  const input = document.getElementById('oauthCodeInput');
  if (!input || !input.value.trim() || !oauthPending) return;
  const code = input.value.trim();
  try {
    const r = await fetch('/api/keys/oauth/complete', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({sessionId: oauthPending.sessionId, code})
    });
    const d = await r.json();
    if (d.error) { showToast('error','OAuth Error', d.error); return; }
    // Move to label step
    oauthPending = {step: 'label', accountId: d.email, suggestedLabel: ''};
    // Store all key profile names for linking dropdown
    window._allKeyProfiles = Object.keys(window._lastAuthData?.profiles || {});
    await loadOAuthUsage();
    renderKeysModal();
  } catch(e) { showToast('error','Error',e.message); }
}

async function saveOAuthLabel() {
  const labelInput = document.getElementById('oauthLabelInput');
  const linkSelect = document.getElementById('oauthLinkKey');
  if (!labelInput || !oauthPending) return;
  const label = labelInput.value.trim() || oauthPending.accountId;
  const linkedKey = linkSelect ? linkSelect.value : '';
  try {
    const r = await fetch('/api/keys/oauth/update', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({accountId: oauthPending.accountId, label, linkedKey})
    });
    const d = await r.json();
    if (d.error) { showToast('error','Error', d.error); return; }
    oauthPending = null;
    showToast('success','Saved', `✅ ${label}`);
    await loadOAuthUsage();
    renderKeysModal();
  } catch(e) { showToast('error','Error',e.message); }
}

async function removeOAuthAccount(email) {
  if (!confirm(`Remove ${email}?`)) return;
  try {
    await fetch('/api/keys/oauth/remove', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({email})
    });
    delete oauthAccounts[email];
    renderKeysModal();
  } catch(e) { showToast('error','Error',e.message); }
}

function getUsageColor(pct) {
  if (pct < 50) return 'var(--green)';
  if (pct < 80) return 'var(--yellow)';
  return 'var(--red)';
}

function formatResetTime(isoStr) {
  if (!isoStr) return '';
  const reset = new Date(isoStr);
  const diff = reset - Date.now();
  if (diff <= 0) return 'resetting...';
  const h = Math.floor(diff / 3600000);
  const m = Math.floor((diff % 3600000) / 60000);
  return h > 0 ? `${h}h ${m}m` : `${m}m`;
}

function renderOAuthSection() {
  const accounts = Object.entries(oauthAccounts).filter(([k]) => k !== 'error');
  const hasAccounts = accounts.length > 0;

  let html = '<div class="oauth-section"><h3>☁️ Claude Account Usage</h3>';

  // Render each connected account's usage
  accounts.forEach(([email, data]) => {
    const label = data.label || email;
    const linkedKey = data.linkedKey || '';
    html += `<div class="oauth-account">
      <div class="oauth-account-header">
        <div class="oauth-account-email">✅ ${escapeHtml(label)}${linkedKey ? ` <span style="font-size:10px;padding:1px 5px;background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:3px;color:var(--text-muted)">🔗 ${escapeHtml(linkedKey.split(':').pop())}</span>` : ''}${data.subscriptionType ? ` <span style="font-size:10px;color:var(--text-dim)">(${escapeHtml(data.subscriptionType)})</span>` : ''}</div>
        <div class="oauth-account-actions">
          <button class="oauth-remove-btn" onclick="removeOAuthAccount('${escapeHtml(email)}')">Remove</button>
        </div>
      </div>`;

    if (data.error) {
      html += `<div class="oauth-error">⚠️ ${escapeHtml(data.message || data.error)}</div>`;
    } else if (data.usage) {
      const u = data.usage;
      html += '<div class="oauth-usage-grid">';

      // 5-hour usage
      if (u.five_hour) {
        const pct = u.five_hour.utilization || 0;
        html += `<div class="oauth-usage-item">
          <div class="oauth-usage-label"><span>Session (5h)</span><span>${pct.toFixed(1)}%</span></div>
          <div class="oauth-usage-bar"><div class="oauth-usage-fill" style="width:${Math.min(pct,100)}%;background:${getUsageColor(pct)}"></div></div>
          <div class="oauth-reset-time">Resets in ${formatResetTime(u.five_hour.resets_at)}</div>
        </div>`;
      }

      // 7-day usage
      if (u.seven_day) {
        const pct = u.seven_day.utilization || 0;
        html += `<div class="oauth-usage-item">
          <div class="oauth-usage-label"><span>Weekly (7d)</span><span>${pct.toFixed(1)}%</span></div>
          <div class="oauth-usage-bar"><div class="oauth-usage-fill" style="width:${Math.min(pct,100)}%;background:${getUsageColor(pct)}"></div></div>
          <div class="oauth-reset-time">Resets in ${formatResetTime(u.seven_day.resets_at)}</div>
        </div>`;
      }

      // Sonnet usage
      if (u.seven_day_sonnet && u.seven_day_sonnet.utilization !== undefined) {
        const pct = u.seven_day_sonnet.utilization || 0;
        html += `<div class="oauth-usage-item">
          <div class="oauth-usage-label"><span>Sonnet (7d)</span><span>${pct.toFixed(1)}%</span></div>
          <div class="oauth-usage-bar"><div class="oauth-usage-fill" style="width:${Math.min(pct,100)}%;background:${getUsageColor(pct)}"></div></div>
          ${u.seven_day_sonnet.resets_at ? `<div class="oauth-reset-time">Resets in ${formatResetTime(u.seven_day_sonnet.resets_at)}</div>` : ''}
        </div>`;
      }

      // Opus usage
      if (u.seven_day_opus && u.seven_day_opus.utilization !== undefined) {
        const pct = u.seven_day_opus.utilization || 0;
        html += `<div class="oauth-usage-item">
          <div class="oauth-usage-label"><span>Opus (7d)</span><span>${pct.toFixed(1)}%</span></div>
          <div class="oauth-usage-bar"><div class="oauth-usage-fill" style="width:${Math.min(pct,100)}%;background:${getUsageColor(pct)}"></div></div>
          ${u.seven_day_opus.resets_at ? `<div class="oauth-reset-time">Resets in ${formatResetTime(u.seven_day_opus.resets_at)}</div>` : ''}
        </div>`;
      }

      // OAuth Apps usage
      if (u.seven_day_oauth_apps && u.seven_day_oauth_apps.utilization !== undefined) {
        const pct = u.seven_day_oauth_apps.utilization || 0;
        html += `<div class="oauth-usage-item">
          <div class="oauth-usage-label"><span>OAuth Apps (7d)</span><span>${pct.toFixed(1)}%</span></div>
          <div class="oauth-usage-bar"><div class="oauth-usage-fill" style="width:${Math.min(pct,100)}%;background:${getUsageColor(pct)}"></div></div>
          ${u.seven_day_oauth_apps.resets_at ? `<div class="oauth-reset-time">Resets in ${formatResetTime(u.seven_day_oauth_apps.resets_at)}</div>` : ''}
        </div>`;
      }

      // Cowork usage
      if (u.seven_day_cowork && u.seven_day_cowork.utilization !== undefined) {
        const pct = u.seven_day_cowork.utilization || 0;
        html += `<div class="oauth-usage-item">
          <div class="oauth-usage-label"><span>Cowork (7d)</span><span>${pct.toFixed(1)}%</span></div>
          <div class="oauth-usage-bar"><div class="oauth-usage-fill" style="width:${Math.min(pct,100)}%;background:${getUsageColor(pct)}"></div></div>
          ${u.seven_day_cowork.resets_at ? `<div class="oauth-reset-time">Resets in ${formatResetTime(u.seven_day_cowork.resets_at)}</div>` : ''}
        </div>`;
      }

      // iguana_necktie (unknown/new metric)
      if (u.iguana_necktie && u.iguana_necktie.utilization !== undefined) {
        const pct = u.iguana_necktie.utilization || 0;
        html += `<div class="oauth-usage-item">
          <div class="oauth-usage-label"><span>🦎 Iguana (7d)</span><span>${pct.toFixed(1)}%</span></div>
          <div class="oauth-usage-bar"><div class="oauth-usage-fill" style="width:${Math.min(pct,100)}%;background:${getUsageColor(pct)}"></div></div>
          ${u.iguana_necktie.resets_at ? `<div class="oauth-reset-time">Resets in ${formatResetTime(u.iguana_necktie.resets_at)}</div>` : ''}
        </div>`;
      }

      html += '</div>';

      // Extra usage
      if (u.extra_usage) {
        if (u.extra_usage.is_enabled) {
          const used = u.extra_usage.used_credits || 0;
          const limit = u.extra_usage.monthly_limit || 0;
          const pct = limit > 0 ? Math.min(100, (used / limit) * 100) : 0;
          html += `<div class="oauth-extra">💳 Extra usage: $${used.toFixed(2)} / $${limit} (${pct.toFixed(1)}% of monthly limit)</div>`;
        } else {
          html += `<div class="oauth-extra" style="opacity:0.5">💳 Extra usage: disabled</div>`;
        }
      }

      // Raw data toggle
      html += `<details style="margin-top:6px"><summary style="font-size:10px;color:var(--text-dim);cursor:pointer;user-select:none">Raw API response</summary><pre style="font-size:9px;color:var(--text-muted);background:var(--bg-base);padding:6px;border-radius:4px;margin-top:4px;overflow-x:auto;max-height:200px">${escapeHtml(JSON.stringify(u, null, 2))}</pre></details>`;
    }
    html += '</div>';
  });

  // Login button
  if (oauthPending && oauthPending.step === 'code') {
    html += `<div style="margin-top:8px">
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">Paste the authorization code from the browser:</div>
      <div class="oauth-code-input">
        <input type="text" id="oauthCodeInput" placeholder="code#state" onkeydown="if(event.key==='Enter')completeOAuthLogin()">
        <button class="btn primary" onclick="completeOAuthLogin()">Connect</button>
        <button class="btn" onclick="oauthPending=null;renderKeysModal()">Cancel</button>
      </div>
    </div>`;
  } else if (oauthPending && oauthPending.step === 'label') {
    html += `<div style="margin-top:8px">
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">✅ Connected! Give this account a name (e.g. email or label):</div>
      <div class="oauth-code-input">
        <input type="text" id="oauthLabelInput" placeholder="yourdev@gmail.com or 'Tona Max 20x'" value="${escapeHtml(oauthPending.suggestedLabel||'')}" onkeydown="if(event.key==='Enter')saveOAuthLabel()">
        <button class="btn primary" onclick="saveOAuthLabel()">Save</button>
      </div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:4px">Link to API key (optional):</div>
      <select id="oauthLinkKey" style="width:100%;margin-top:4px;padding:4px 8px;background:var(--bg-elevated);border:1px solid var(--border-default);border-radius:4px;color:var(--text-secondary);font-size:12px">
        <option value="">None</option>
        ${(window._allKeyProfiles||[]).map(k => `<option value="${escapeHtml(k)}">${escapeHtml(k.split(':').pop())}</option>`).join('')}
      </select>
    </div>`;
  } else {
    html += `<button class="oauth-login-btn" onclick="startOAuthLogin()" style="margin-top:8px">
      ☁️ ${hasAccounts ? 'Add another account' : 'Login with Claude'}
    </button>`;
  }

  html += '</div>';
  return html;
}
</script>
</body>
</html>
