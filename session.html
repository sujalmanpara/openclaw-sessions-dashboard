<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Session ‚Äî Cozy Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}

:root{
  --bg-base:#09090b;
  --bg-surface:#0c0c10;
  --bg-elevated:#141418;
  --border-subtle:#1e1e24;
  --border-default:#2a2a32;
  --border-hover:#3a3a44;
  --text-primary:#fafafa;
  --text-secondary:#a1a1aa;
  --text-muted:#71717a;
  --text-dim:#3f3f46;
  --accent:#7c6ff7;
  --green:#22c55e;
  --yellow:#eab308;
  --red:#ef4444;
  --blue:#3b82f6;
  --font-mono:'SF Mono',Monaco,'Cascadia Code',monospace;
  --font-sans:-apple-system,BlinkMacSystemFont,'Segoe UI','Inter',sans-serif;
  --radius:8px;
}

body{
  font-family:var(--font-sans);
  background:var(--bg-base);
  color:var(--text-primary);
  height:100dvh;
  display:flex;flex-direction:column;
  overflow:hidden;
}

/* Header */
.header{
  padding:10px 16px;
  border-bottom:1px solid var(--border-subtle);
  background:var(--bg-surface);
  display:flex;justify-content:space-between;align-items:center;
  flex-shrink:0;
}
.header-left{display:flex;align-items:center;gap:10px;min-width:0;flex:1}
.header-title{font-size:14px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.header-meta{font-size:11px;color:var(--text-dim);display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.back-link{font-size:12px;color:var(--accent);text-decoration:none;opacity:.7;flex-shrink:0}
.back-link:hover{opacity:1}
.header-controls{display:flex;gap:4px;align-items:center;flex-shrink:0}

/* Badges ‚Äî same as main */
.badge{font-size:10px;padding:1px 6px;border-radius:4px;border:1px solid}
.badge-subagent{background:rgba(124,111,247,.06);color:rgba(124,111,247,.6);border-color:rgba(124,111,247,.1)}
.badge-main{background:rgba(34,197,94,.06);color:rgba(34,197,94,.6);border-color:rgba(34,197,94,.1)}
.badge-cron,.badge-cron-run{background:rgba(234,179,8,.06);color:rgba(234,179,8,.6);border-color:rgba(234,179,8,.1)}
.badge-telegram,.badge-group{background:rgba(59,130,246,.06);color:rgba(59,130,246,.6);border-color:rgba(59,130,246,.1)}
.badge-other{background:rgba(255,255,255,.04);color:var(--text-muted);border-color:rgba(255,255,255,.06)}

/* Tabs */
.panel-tabs{display:flex;gap:0;border-bottom:1px solid var(--border-subtle);flex-shrink:0;background:var(--bg-elevated);padding:0 12px}
.panel-tab{padding:6px 14px;font-size:11px;color:var(--text-muted);background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;transition:all .15s}
.panel-tab:hover{color:var(--text-secondary)}
.panel-tab.active{color:var(--accent);border-bottom-color:var(--accent)}

/* Log container */
.log-container{
  flex:1;overflow-y:auto;padding:12px 16px;
  font-family:var(--font-sans);font-size:13px;
  scroll-behavior:smooth;
}

/* Log entries ‚Äî exact copy from main dashboard */
.log-entry{margin:12px 0;padding-left:12px;border-left:2px solid var(--border-subtle)}
.log-entry.role-user{border-color:rgba(59,130,246,.3)}
.log-entry.role-assistant{border-color:rgba(124,111,247,.3)}
.log-entry.role-tool{border-color:rgba(234,179,8,.2)}

.log-header{display:flex;align-items:center;margin-bottom:4px;gap:8px}
.log-role{
  font-size:10px;font-weight:600;text-transform:uppercase;
  padding:1px 6px;border-radius:4px;border:1px solid;
}
.role-user{background:rgba(59,130,246,.08);color:rgba(59,130,246,.6);border-color:rgba(59,130,246,.12)}
.role-assistant{background:rgba(124,111,247,.08);color:rgba(124,111,247,.6);border-color:rgba(124,111,247,.12)}
.role-tool{background:rgba(234,179,8,.06);color:rgba(234,179,8,.5);border-color:rgba(234,179,8,.1)}

.log-timestamp{font-size:10px;color:var(--text-dim);margin-left:auto;font-variant-numeric:tabular-nums}
.log-content{margin-bottom:4px}

.log-text{font-size:13px;line-height:1.6;white-space:pre-wrap;word-break:break-word;color:var(--text-secondary)}
.log-text h1,.log-text h2,.log-text h3{margin:8px 0 4px;color:var(--text-primary);text-wrap:balance}
.log-text h1{font-size:18px}.log-text h2{font-size:15px}.log-text h3{font-size:14px}
.log-text p{margin:4px 0}
.log-text ul,.log-text ol{margin:4px 0;padding-left:20px}
.log-text code{background:var(--bg-elevated);padding:1px 4px;border-radius:4px;font-family:var(--font-mono);font-size:12px}
.log-text pre{background:var(--bg-elevated);padding:8px 12px;border-radius:var(--radius);overflow-x:auto;margin:8px 0;border:1px solid var(--border-subtle)}
.log-text pre code{background:none;padding:0}
.log-text a{color:var(--accent);text-decoration:none}
.log-text a:hover{text-decoration:underline}

.tool-call{background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius);margin:8px 0;overflow:hidden}
.tool-header{padding:8px 12px;background:var(--bg-surface);border-bottom:1px solid var(--border-subtle);display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.tool-name{font-size:12px;color:var(--text-secondary);font-weight:500;display:flex;align-items:center;gap:4px}
.tool-toggle{color:var(--text-dim);transition:transform .15s;font-size:10px}
.tool-call.expanded .tool-toggle{transform:rotate(180deg)}
.tool-content{display:none}
.tool-call.expanded .tool-content{display:block}
.tool-args,.tool-result{padding:8px 12px;font-size:11px;font-family:var(--font-mono)}
.tool-args{color:var(--text-muted);background:var(--bg-base);white-space:pre-wrap;word-break:break-all;border-bottom:1px solid var(--border-subtle)}
.tool-result{color:var(--text-secondary);background:var(--bg-surface)}
.tool-pending{padding:8px 12px;color:var(--text-dim);font-style:italic;font-size:11px;background:var(--bg-base)}

.copy-btn{background:var(--bg-elevated);border:1px solid var(--border-default);color:var(--text-dim);padding:2px 8px;border-radius:4px;cursor:pointer;font-size:10px;transition:color .15s;font-family:inherit}
.copy-btn:hover{color:var(--text-secondary)}

.image-preview{max-width:100%;max-height:300px;border-radius:var(--radius);border:1px solid var(--border-subtle);margin:8px 0;cursor:pointer;transition:border-color .15s}
.image-preview:hover{border-color:var(--border-default)}

.thinking-block{background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius);padding:8px 12px;margin:8px 0;font-style:italic;color:var(--text-muted);font-size:11px}

.log-meta{display:flex;gap:8px;margin-top:4px;font-size:10px;color:var(--text-dim);font-variant-numeric:tabular-nums}
.log-cost{color:var(--text-muted);font-weight:500;background:rgba(234,179,8,.06);padding:1px 4px;border-radius:4px}
.log-tokens{color:var(--text-dim)}
.log-model{color:var(--text-dim)}

/* Send bar */
.send-bar{
  padding:8px 16px;border-top:1px solid var(--border-subtle);
  background:var(--bg-surface);display:flex;gap:8px;flex-shrink:0;align-items:center;
}
.send-bar input{
  flex:1;padding:8px 12px;
  background:var(--bg-elevated);border:1px solid var(--border-default);
  border-radius:6px;color:var(--text-primary);font-size:13px;
  font-family:var(--font-sans);outline:none;
}
.send-bar input:focus{border-color:var(--accent)}
.send-btn{
  width:32px;height:32px;border-radius:6px;
  background:var(--accent);border:none;color:#fff;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:opacity .15s;flex-shrink:0;
}
.send-btn:hover{opacity:.85}

.btn{padding:4px 10px;background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-muted);cursor:pointer;font-size:11px;font-family:var(--font-sans)}
.btn:hover{border-color:var(--border-default);color:var(--text-secondary)}

/* Sub-agents */
.subagents-container{flex:1;overflow-y:auto;padding:16px;display:none}
.subagent-card{background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:6px;padding:10px 12px;margin-bottom:8px;cursor:pointer;transition:border-color .15s}
.subagent-card:hover{border-color:var(--border-default)}
.subagent-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.subagent-card-name{font-size:13px;font-weight:500;color:var(--text-primary)}
.subagent-card-meta{font-size:10px;color:var(--text-dim);display:flex;gap:8px;flex-wrap:wrap}
.subagent-card-status{font-size:10px;padding:1px 6px;border-radius:3px}
.subagent-card-status.running{background:rgba(34,197,94,.1);color:rgba(34,197,94,.7)}
.subagent-card-status.completed{background:rgba(59,130,246,.1);color:rgba(59,130,246,.7)}
.subagent-card-status.error{background:rgba(239,68,68,.1);color:rgba(239,68,68,.7)}

.loading{text-align:center;padding:40px;color:var(--text-dim);font-size:13px}
.empty-state{text-align:center;padding:40px;color:var(--text-dim)}

/* Toast */
.toast-container{position:fixed;top:16px;right:16px;z-index:999;display:flex;flex-direction:column;gap:8px}
.toast{padding:8px 14px;border-radius:6px;font-size:12px;background:var(--bg-elevated);border:1px solid var(--border-subtle);color:var(--text-secondary);animation:fadeIn .2s}
.toast.success{border-color:rgba(34,197,94,.2);color:rgba(34,197,94,.8)}
.toast.error{border-color:rgba(239,68,68,.2);color:rgba(239,68,68,.8)}
@keyframes fadeIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <a href="/" class="back-link">‚Üê Dashboard</a>
    <div class="header-title" id="sessionTitle">Loading...</div>
    <div class="header-meta" id="sessionMeta"></div>
  </div>
  <div class="header-controls">
    <button class="btn" onclick="copyTranscript()">Copy</button>
    <button class="btn" onclick="location.reload()">‚Üª</button>
  </div>
</div>

<div class="panel-tabs" id="panelTabs" style="display:none">
  <button class="panel-tab active" data-tab="transcript" onclick="switchTab('transcript',this)">Transcript</button>
  <button class="panel-tab" data-tab="subagents" onclick="switchTab('subagents',this)">Sub-agents</button>
</div>

<div class="log-container" id="logContainer">
  <div class="loading">Loading session...</div>
</div>
<div class="subagents-container" id="subagentsContainer"></div>

<div class="send-bar" id="sendBar">
  <input type="text" id="sendInput" placeholder="Send a message to this session‚Ä¶" autocomplete="off"
    onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}">
  <button class="send-btn" onclick="sendMessage()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
  </button>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
const sessionKey = decodeURIComponent(location.pathname.replace('/session/', ''));
let session = null;
let allSessions = [];
let transcriptEntries = [];
let transcriptTotal = 0;
let transcriptOffset = 0;

function escapeHtml(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

function formatTime(ts) {
  if (!ts) return '‚Äî';
  const diff = Date.now() - ts;
  if (diff < 60000) return Math.floor(diff/1000) + 's';
  if (diff < 3600000) return Math.floor(diff/60000) + 'm';
  if (diff < 86400000) return Math.floor(diff/3600000) + 'h';
  return Math.floor(diff/86400000) + 'd';
}

function formatTimestamp(ts) {
  if (!ts) return '';
  return new Date(ts).toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
}

function formatBadgeLabel(type) {
  const labels = {main:'main',group:'group',telegram:'telegram',cron:'cron','cron-run':'run',subagent:'sub-agent',other:'other'};
  return labels[type] || type;
}

function getSessionName(s) {
  if (s.label) return s.label;
  if (s.displayName) return s.displayName;
  return s.key.split(':').pop().slice(0, 12);
}

function showToast(type, title, msg) {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = `${title}: ${msg}`;
  c.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

function toggleToolCall(element) { element.classList.toggle('expanded'); }

function copyText(text) {
  navigator.clipboard.writeText(text).then(() => showToast('success', 'Copied', 'Text copied'))
    .catch(() => showToast('error', 'Error', 'Failed to copy'));
}

function switchTab(tab, btn) {
  document.querySelectorAll('.panel-tab').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  document.getElementById('logContainer').style.display = tab === 'transcript' ? '' : 'none';
  document.getElementById('sendBar').style.display = tab === 'transcript' ? '' : 'none';
  document.getElementById('subagentsContainer').style.display = tab === 'subagents' ? '' : 'none';
  if (tab === 'subagents') renderSubagents();
}

function renderSubagents() {
  const container = document.getElementById('subagentsContainer');
  const children = allSessions.filter(s => {
    if (s.sessionType !== 'subagent') return false;
    return s.parentKey === session.key || s.key.startsWith(session.key.replace(/:main$/, '') + ':subagent:');
  }).sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));

  let agents = children;
  if (!agents.length) {
    const childKeys = (session.children || []).map(c => c.key);
    agents = allSessions.filter(s => childKeys.includes(s.key)).sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
  }

  if (!agents.length) {
    container.innerHTML = '<div class="empty-state"><p>No sub-agents found</p></div>';
    return;
  }

  container.innerHTML = `<div style="font-size:11px;color:var(--text-dim);margin-bottom:8px">${agents.length} sub-agent${agents.length !== 1 ? 's' : ''}</div>` +
    agents.map(s => {
      const status = s.status === 'running' ? 'running' : (s.abortedLastRun ? 'error' : 'completed');
      const statusLabel = status === 'running' ? '‚óè running' : (status === 'error' ? '‚úó error' : '‚úì done');
      const name = s.label || s.displayName || s.key.split(':').pop().slice(0, 8);
      const tokens = s.totalTokens ? `${(s.totalTokens/1000).toFixed(1)}k tok` : '';
      const model = s.model ? s.model.split('/').pop() : '';
      const ago = s.updatedAt ? formatTime(s.updatedAt) + ' ago' : '';
      return `<div class="subagent-card" onclick="window.open('/session/${encodeURIComponent(s.key)}','_blank')">
        <div class="subagent-card-header">
          <div class="subagent-card-name">${escapeHtml(name)}</div>
          <span class="subagent-card-status ${status}">${statusLabel}</span>
        </div>
        <div class="subagent-card-meta">
          ${model ? `<span>ü§ñ ${escapeHtml(model)}</span>` : ''}
          ${tokens ? `<span>üìä ${tokens}</span>` : ''}
          ${ago ? `<span>üïê ${ago}</span>` : ''}
        </div>
      </div>`;
    }).join('');
}

// Exact same renderTranscript as main dashboard
function renderTranscript(entries) {
  const container = document.getElementById('logContainer');
  if (!entries.length) { container.innerHTML = '<div class="empty-state"><p>No entries</p></div>'; return; }

  const resultMap = {};
  entries.forEach(entry => {
    (entry.content || []).forEach(c => { if (c.type === 'result' && c.id) resultMap[c.id] = c; });
  });
  const renderedResults = new Set();

  const html = entries.map(entry => {
    const role = entry.role || 'system';
    let contentHtml = '';
    (entry.content || []).forEach(c => {
      if (c.type === 'tool') {
        const result = resultMap[c.id];
        let resultHtml;
        if (result) {
          renderedResults.add(c.id);
          resultHtml = `<div class="tool-content">
            <div class="tool-args">${escapeHtml(JSON.stringify(c.args || {}, null, 2))}</div>
            <div class="tool-result">
              <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                <span style="color:rgba(34,197,94,.6);font-weight:600;font-size:10px">RESULT</span>
                <button class="copy-btn" onclick="event.stopPropagation();copyText(this.closest('.tool-result').textContent)">copy</button>
              </div>
              ${escapeHtml(result.text || '(empty)')}
            </div>
          </div>`;
        } else {
          resultHtml = `<div class="tool-content">
            <div class="tool-args">${escapeHtml(JSON.stringify(c.args || {}, null, 2))}</div>
            <div class="tool-pending">Waiting for result...</div>
          </div>`;
        }
        contentHtml += `<div class="tool-call" onclick="toggleToolCall(this)">
          <div class="tool-header">
            <div class="tool-name">${escapeHtml(c.name)}</div>
            <div class="tool-toggle">&#9660;</div>
          </div>
          ${resultHtml}
        </div>`;
      } else if (c.type === 'result' && !renderedResults.has(c.id)) {
        contentHtml += `<div class="tool-call expanded">
          <div class="tool-header">
            <div class="tool-name">${escapeHtml(c.name)}</div>
            <button class="copy-btn" onclick="event.stopPropagation();copyText(this.closest('.tool-call').querySelector('.tool-result')?.textContent||'')">copy</button>
          </div>
          <div class="tool-content"><div class="tool-result">${escapeHtml(c.text || '(empty)')}</div></div>
        </div>`;
      } else if (c.type === 'text') {
        contentHtml += `<div class="log-text">${marked.parse(c.text || '')}</div>
          <button class="copy-btn" onclick="copyText(${JSON.stringify(c.text || '')})">copy</button>`;
      } else if (c.type === 'image') {
        contentHtml += `<img class="image-preview" src="${escapeHtml(c.url)}"
          onclick="window.open('${escapeHtml(c.url)}','_blank')"
          onerror="this.outerHTML='<span style=color:var(--text-dim)>Image: '+this.src+'</span>'" />`;
      } else if (c.type === 'thinking') {
        contentHtml += `<div class="thinking-block">${escapeHtml(c.text)}</div>`;
      }
    });
    if (!contentHtml.trim()) return '';
    const metaHtml = [];
    if (entry.model) metaHtml.push(`<span class="log-model">${entry.model}</span>`);
    if (entry.cost > 0) metaHtml.push(`<span class="log-cost">$${entry.cost.toFixed(4)}</span>`);
    if (entry.tokens && (entry.tokens.in || entry.tokens.out)) {
      metaHtml.push(`<span class="log-tokens">${entry.tokens.in}&#8594;${entry.tokens.out}</span>`);
      if (entry.tokens.cache) metaHtml.push(`<span class="log-tokens">${entry.tokens.cache} cached</span>`);
    }
    return `<div class="log-entry role-${role}">
      <div class="log-header">
        <div class="log-role role-${role}">${role.toUpperCase()}</div>
        <div class="log-timestamp">${formatTimestamp(entry.ts)}</div>
      </div>
      ${contentHtml}
      ${metaHtml.length ? `<div class="log-meta">${metaHtml.join(' ')}</div>` : ''}
    </div>`;
  }).filter(h => h).join('');

  container.innerHTML = html;
  setTimeout(() => { container.scrollTop = container.scrollHeight; }, 100);
}

async function loadTranscript(sessionId) {
  const container = document.getElementById('logContainer');
  container.innerHTML = '<div class="loading">Loading transcript...</div>';
  try {
    const r = await fetch(`/data/transcript/${sessionId}?limit=200`);
    const d = await r.json();
    if (d.error) { container.innerHTML = `<div class="loading">${d.error}</div>`; return; }
    transcriptEntries = d.entries || [];
    transcriptTotal = d.total || transcriptEntries.length;
    transcriptOffset = d.offset || 0;
    renderTranscript(transcriptEntries);
    container.scrollTop = container.scrollHeight;
    if (transcriptOffset > 0) setupInfiniteScroll(sessionId, container);
  } catch(e) { container.innerHTML = `<div class="loading">Failed: ${e.message}</div>`; }
}

let _loadingMore = false;
function setupInfiniteScroll(sessionId, container) {
  container.addEventListener('scroll', async function handler() {
    if (_loadingMore || transcriptOffset <= 0 || container.scrollTop > 100) return;
    _loadingMore = true;
    const prevHeight = container.scrollHeight;
    const loadOffset = Math.max(0, transcriptOffset - 100);
    const loadLimit = transcriptOffset - loadOffset;
    try {
      const r = await fetch(`/data/transcript/${sessionId}?offset=${loadOffset}&limit=${loadLimit}`);
      const d = await r.json();
      if (d.entries?.length) {
        transcriptEntries = [...d.entries, ...transcriptEntries];
        transcriptOffset = loadOffset;
        renderTranscript(transcriptEntries);
        container.scrollTop = container.scrollHeight - prevHeight;
        if (transcriptOffset <= 0) container.removeEventListener('scroll', handler);
      }
    } catch(e) {}
    _loadingMore = false;
  });
}

async function refreshTranscript(sessionId) {
  try {
    const r = await fetch(`/data/transcript/${sessionId}?limit=100`);
    const d = await r.json();
    if (!d.entries) return;
    const container = document.getElementById('logContainer');
    const wasAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 100;
    const newTotal = d.total || 0;
    if (newTotal !== transcriptTotal) {
      const oldPrefix = transcriptEntries.slice(0, transcriptEntries.length - (transcriptTotal - (d.offset || 0)));
      transcriptEntries = [...oldPrefix, ...d.entries];
      transcriptTotal = newTotal;
      renderTranscript(transcriptEntries);
      if (wasAtBottom) container.scrollTop = container.scrollHeight;
    }
  } catch(e) {}
}

function copyTranscript() {
  const text = transcriptEntries.map(e => {
    const role = e.role || 'unknown';
    let content = '';
    if (Array.isArray(e.content)) content = e.content.map(b => b.text || '').filter(Boolean).join('\n');
    else content = e.content || '';
    return `[${role}] ${content}`;
  }).join('\n\n');
  navigator.clipboard.writeText(text).then(() => showToast('success','Copied','Transcript copied'));
}

async function sendMessage() {
  const input = document.getElementById('sendInput');
  const msg = input.value.trim();
  if (!msg || !session) return;
  input.value = '';
  try {
    await fetch('/api/session/send', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({sessionKey: session.key, message: msg})
    });
    showToast('success','Sent','Message sent');
  } catch(e) { showToast('error','Error',e.message); }
}

async function init() {
  try {
    const r = await fetch('/data/sessions.json');
    const d = await r.json();
    allSessions = d.sessions || [];
    session = allSessions.find(s => s.key === sessionKey);

    if (!session) {
      document.getElementById('sessionTitle').textContent = 'Session not found';
      document.getElementById('logContainer').innerHTML = `<div class="loading">Session key: ${escapeHtml(sessionKey)}<br>Not found in active sessions.</div>`;
      return;
    }

    document.getElementById('sessionTitle').textContent = getSessionName(session);
    document.title = getSessionName(session) + ' ‚Äî Cozy Dashboard';
    document.getElementById('sessionMeta').innerHTML = `
      <span>${session.channel || '‚Äî'}</span>
      <span>${session.sessionId?.slice(0, 8) || '‚Äî'}</span>
      <span>${formatTime(session.updatedAt)} ago</span>
      <span class="badge badge-${session.sessionType || 'other'}">${formatBadgeLabel(session.sessionType || 'other')}</span>
      ${session.totalTokens ? `<span>${(session.totalTokens/1000).toFixed(1)}k tokens</span>` : ''}
      ${session.model ? `<span>${session.model.split('/').pop()}</span>` : ''}
    `;

    const hasSubagents = (session.children || []).some(c => c.key?.includes(':subagent:')) ||
      allSessions.some(s => s.sessionType === 'subagent' && s.parentKey === session.key);
    if (hasSubagents) document.getElementById('panelTabs').style.display = '';

    await loadTranscript(session.sessionId);
    setInterval(() => refreshTranscript(session.sessionId), 3000);
  } catch(e) {
    document.getElementById('logContainer').innerHTML = `<div class="loading">Error: ${e.message}</div>`;
  }
}

init();
</script>
</body>
</html>
